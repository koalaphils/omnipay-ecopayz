{% extends 'AppBundle:Layout:base.html.twig' %}

{% block title %}{{ "page.title.list"|trans({},"CustomerBundle") }}{% endblock %}

{% block stylesheets %}
    <!-- DataTables -->
    <link href="{{ asset('assets/plugins/datatables/jquery.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.colVis.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block pageTitle %}{{ "settings.customerProfilling.label"|trans({},"CustomerBundle") }}{% endblock pageTitle %}

{% block pageHeaderExtra %}
    <div class="pull-right">
        <a class="btn btn-primary waves-effect waves-light pull-right m-b-10" href="{{ path('customer.risk_setting.create') }}"> <span><i class="ti-plus m-r-5"></i></span> {{ "Add Risk Setting"|trans({}, 'CustomerBundle') }}</a>
        <ul class="list-inline quicklinks font-13 font-normal text-right">
            <li>Quick Links:</li>
            <li><a href="{{ path("customer.list_page") }}">{{ "Customer List"|trans({}, 'CustomerBundle') }}</a></li>
        </ul>
    </div>
{% endblock pageHeaderExtra %}

{% block breadcrumb -%}
    <li>{{ "breadcrumb.setting"|trans({},"AppBundle") }}</li>
    <li class="active">{{ "settings.customerProfilling.label"|trans({},"CustomerBundle") }}</li>
{%- endblock %}

{% block page %}
    <div class="col-sm-12">
        <div class="card-box">
            <div id="riskSetting">
                <table id="datatable-responsive"
                       class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0"
                       width="100%">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th data-priority="1">{{ "fields.riskSetting.riskId"|trans({}, "CustomerBundle") }}</th>
                        <th>{{ "fields.status"|trans({}, "CustomerBundle") }}</th>
                        <th data-priority="2">{{ "fields.action"|trans({}, "AppBundle") }}</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>
    </div>
{% endblock page %}

{% block javascripts %}
    <script src="{{ asset('bundles/app/js/ZTable.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.bootstrap.js') }}"></script>

    <script src="{{ asset('assets/plugins/datatables/dataTables.buttons.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/vfs_fonts.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/buttons.html5.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.colVis.js') }}"></script>

    <script type="text/javascript">
        $(function(){
            $('#riskSetting').list({
                'url': {
                    'list': '{{ path("customer.risk_setting.search") }}'
                },
                'rowOnclick': function (e, zTable) {
                    dataTable = zTable.dataTable.api();
                    e.preventDefault();
                    var currentRow = $(e.target).parents('tr');
                    if (currentRow.hasClass('child')) {
                        currentRow = currentRow.prev();
                    }
                    var data = dataTable.row(currentRow).data() ;
                    var anchor = $(e.target).closest('a');
                    var mode = anchor.attr('action');

                    if (mode == 'suspend') {
                        suspendRiskSetting(data);
                    } else if (mode == 'activate') {
                        activateRiskSetting(data);
                    }
                }
            });
        });

        function suspendRiskSetting(riskSetting)
        {

            confirm2('Are you sure you want to suspend '+ riskSetting.risk_id, 'Suspend Risk Setting', {
                'type': null,
                'confirmButtonClass': 'btn-success btn-md',
                'confirmButtonText': 'Yes',
                'cancelButtonClass': 'btn-inverse btn-md',
                'cancelButtonText': 'Cancel',
                'html': true,
                'showLoaderOnConfirm': true
            }, function(isSuspended) {
                if(isSuspended) {
                    $.ajax({
                        url : "{{ path('customer.risk_setting.suspend') }}",
                        globalAjaxComplete : false,
                        type: "POST",
                        dataType: "JSON",
                        data: {
                            "riskSettingId": riskSetting.id
                        },
                        success : function (data) {
                            var notifications = data.__notifications || [];
                            swal({
                                'type': notifications.type,
                                'title': notifications.title,
                                'text': notifications.message
                            }, function() {
                                $('#riskSetting').trigger('refresh');
                            });
                        }
                    });
                }
            });
        }

        function activateRiskSetting(riskSetting)
        {
            confirm2('Are you sure you want to activate '+ riskSetting.risk_id, 'Activate Risk Setting', {
                'type': null,
                'confirmButtonClass': 'btn-success btn-md',
                'confirmButtonText': 'Yes',
                'cancelButtonClass': 'btn-inverse btn-md',
                'cancelButtonText': 'Cancel',
                'html': true,
                'showLoaderOnConfirm': true
            }, function(isActivated) {
                if(isActivated) {
                    $.ajax({
                        url : "{{ path('customer.risk_setting.activate') }}",
                        globalAjaxComplete : false,
                        type: "POST",
                        dataType: "JSON",
                        data: {
                            "riskSettingId": riskSetting.id
                        },
                        'success': function (data) {
                            var notifications = data.__notifications || [];
                            swal({
                                'type': notifications.type,
                                'title': notifications.title,
                                'text': notifications.message
                            }, function() {
                                $('#riskSetting').trigger('refresh');
                            });
                        }
                    });
                }
            });
        }

        (function($){
            $.fn.list = function(options, params){
                var settings = options;
                params = params || [];
                return this.each(function(){
                    var elem = $(this);
                    settings = $.extend(true,_defaults(),options);
                    init(elem, settings);
                });
            };

            function init(elem, settings) {
                initTable(elem, settings);
            }

            function initTable(elem, settings) {
                var table = $(elem).find('table');
                var listUrl = settings.url.list;
                var userPreferences = {{ app.user.getPreference('ui.riskSetting.list.column.visibility')|json_encode()|raw }};
                var dataTable = new ZTable('#riskSetting',  {
                    'ajax': {
                        'url': settings.url.list,
                        'data': function (data, dataTable) {
                            return {
                                'search': data.filters.search,
                                'length': data.length,
                                'start': dataTable.start,
                                'datatable': true,
                                'route': true,
                                'draw': dataTable.draw,
                                'order': data.order
                            };
                        },
                        'dataFilter': function (str) {
                            return str;
                        }
                    },
                    'colvis': {
                        'hidden': function () {
                            var hidden = [];
                            for (var i in userPreferences) {
                                if (userPreferences[i] == 'false') {
                                    hidden.push(eval(i));
                                }
                            }
                            return hidden;
                        },

                        'exclude': ['code', 'name']
                    },
                    'columns': settings.columns,
                    'ordering': true,
                    'attrs': {
                        'colvisButton' : {
                            'data-style': 'btn-primary'
                        }
                    }

                });

                $(table).on('click', 'td a.active-state-action', function(e) {
                    settings.rowOnclick(e, dataTable);
                });

                $('#riskSetting table').on('draw.dt', function () {
                    dataTable.dataTable.api().columns.adjust().responsive.recalc();
                });

                $(elem).on('refresh', { "dataTable": dataTable}, function(event){
                    dataTable.reloadTable();
                });
            }

            function _defaults() {
                return {
                    'columns': [
                        {
                            'data': 'resource_id',
                            'name': 'resource_id',
                            'defaultContent': '',
                            'render': function(resource_id) {

                                return 'IDtag' + resource_id;
                            }
                        },
                        {
                            'data': 'risk_id',
                            'name': 'risk_id',
                            'defaultContent': ''
                        },
                        {
                            'data': 'is_active',
                            'name': 'is_active',
                            'defaultContent': '',
                            'render': function(data) {

                                return (data) ? "Active" : "Suspended";
                            }
                        },
                        {
                            'data': 'data',
                            'name': 'action',
                            'defaultContent': '',
                            'render': function(data, text, full) {
                                {% if is_granted('ROLE_CUSTOMER_RISK_SETTING_UPDATE') %}
                                var action = "";
                               var action = "<a class='btn btn-primary waves-effect waves-light btn-xs' title='Edit Risk Setting' href='" + full._link.page + "'>Edit</a>";
                                var suspend = "<a action='suspend' class='btn btn-danger waves-effect waves-light m-r-10 btn-xs active-state-action' title='Suspend Customer Profiling'>Suspend</a>";
                                var activate = "<a action='activate' title='Activate Customer Profiling' class='btn btn-default waves-effect waves-light btn-xs active-state-action'>Activate</a>&nbsp;";

                                if (full.is_active) {
                                    action = action + '&nbsp;' + suspend;
                                } else {
                                    action = action + '&nbsp;' + activate;
                                }

                                return action;
                                {% endif %}
                            }
                        }
                    ]
                };
            }
        })(jQuery);
    </script>

{% endblock %}