{% extends 'AppBundle:Layout:base-v2.html.twig' %}

{% widget_template widgets.setting 'CommissionBundle:Setting:setting-form.html.twig' %}
{% form_theme widgets.setting.getFormView() 'CommissionBundle:Setting:setting-form.html.twig' %}

{% block title %}{{ "page.title.create"|trans({},"CommissionBundle") }}{% endblock %}

{% block stylesheet_plugins %}
    {% for widget in widgets %}
        {{ widget_render_block(widget, 'assetcss') }}
    {% endfor %}
{% endblock stylesheet_plugins %}

{% block stylesheets %}
    {% for widget in widgets %}
        {{ widget_render_block(widget, 'stylesheet') }}
    {% endfor %}
{% endblock %}

{% block pageTitle -%}{{ "Commission Setting"|trans({},"CommissionBundle") }}{%- endblock %}

{% block pageHeaderExtra %}
{% endblock pageHeaderExtra %}

{% block breadcrumb -%}
    <li>{{ "Commission"|trans({},"CommissionBundle") }}</li>
    <li class="active">{{ "Setting"|trans({},"CommissionBundle") }}</li>
{%- endblock %}

{% block page %}
    <div class="col-sm-12">
        <ul class="nav nav-tabs"> 
            <li class="active"> 
                <a href="#setting" data-toggle="tab">
                    <span class="hidden-xs">{{ "Setting" | trans({}, "CommissionBundle") }}</span> 
                </a> 
            </li> 
            <li class=""> 
                <a href="#periods" data-toggle="tab"> 
                    <span class="hidden-xs">{{ "Periods" | trans({}, "CommissionBundle") }}</span> 
                </a> 
            </li>
        </ul>
        <div class="tab-content bg-muted">
            <div class="tab-pane active" id="setting">
                {{ widget_render(widgets.setting) }}
            </div>
            <div class="tab-pane" id="periods">
                <div class="card-box">
                    {{ widget_render(widgets.periods) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript_plugins %}
    {% for widget in widgets %}
        {{ widget_render_block(widget, 'assetjs') }}
    {% endfor %}
{% endblock javascript_plugins %}

{% block javascripts %}
    <script>

        $(document).ready(function (){
            $(document).on('click','.recompute-commission-button', function () {
                var commissionPeriodId = $(this).attr('data-period-id');
                var iconPlaceholder = $(this).parent().find('.icon-holder');
                iconPlaceholder.addClass('fa fa-refresh fa-spin');
                $('.recompute-commission-button').not(this).attr('disabled','disabled');
                recomputeAndPayoutCommissionPeriod(commissionPeriodId, function () {
                    iconPlaceholder.removeClass('fa fa-refresh fa-spin');
                    $('.recompute-commission-button').not(this).removeAttr('disabled');
                    notification('Computation now in progress...');
                });
            });

            $(document).on('click','.recompute-revenueshare-button', function () {
                var commissionPeriodId = $(this).attr('data-period-id');
                var iconPlaceholder = $(this).parent().find('.icon-holder');
                iconPlaceholder.addClass('fa fa-refresh fa-spin');
                $('.recompute-revenueshare-button').not(this).attr('disabled','disabled');
                recomputeAndPayoutRevenueShareCommissionPeriod(commissionPeriodId, function () {
                    iconPlaceholder.removeClass('fa fa-refresh fa-spin');
                    $('.recompute-revenueshare-button').not(this).removeAttr('disabled');
                    notification('Computation of Revenue Share is now in progress...');
                });
            });
        });

        function getComputeButton(data, type, row)
        {
            var computeButton = '';
            /*switch (row.commissionPeriod.status) {
                case Global.commmission.status.successfulPayout:
                case Global.commmission.status.successfulComputation:
                case Global.commmission.status.failedComputation:
                case Global.commmission.status.failedPayout:
                    computeButton = '<button class="btn btn-sm btn-default recompute-commission-button" data-period-id="'+ row.commissionPeriod.id +'" ><span class="icon-holder"></span>Commission</button>';
                break;
            }*/

            switch (row.commissionPeriod.revenue_share_status) {
                case Global.commmission.status.successfulComputation:
                case Global.commmission.status.notYetComputed:
                case Global.commmission.status.failedComputation:
                case Global.commmission.status.failedPayout:
                    computeButton += '<button class="btn btn-sm btn-default recompute-revenueshare-button" data-period-id="'+ row.commissionPeriod.id +'">Revenue Share</button>';
                break;
            }
                
            return computeButton;
        }

        function recomputeAndPayoutCommissionPeriod(commissionPeriodId, actionsAfterCompletingRecomputation) {
            var recomputeUrl = '{{ path('commission.recompute_and_payout',{'commissionPeriodId':'__COMMISSION_PERIOD_ID__'}) }}';
            recomputeUrl = recomputeUrl.replace('__COMMISSION_PERIOD_ID__',commissionPeriodId);
            $.post(recomputeUrl, {'commissionPeriodId': commissionPeriodId}, function (resultData) {
                actionsAfterCompletingRecomputation();
            });
        }

        function recomputeAndPayoutRevenueShareCommissionPeriod(commissionPeriodId, actionsAfterCompletingRecomputation) {
            var recomputeUrl = '{{ path('commission.recompute_and_payout_revenue_share',{'commissionPeriodId':'__COMMISSION_PERIOD_ID__'}) }}';
            recomputeUrl = recomputeUrl.replace('__COMMISSION_PERIOD_ID__',commissionPeriodId);
            $.post(recomputeUrl, {'commissionPeriodId': commissionPeriodId}, function (resultData) {
                actionsAfterCompletingRecomputation();
            });
        }

    </script>

    {% for widget in widgets %}
        {{ widget_render_block(widget, 'javascript') }}
    {% endfor %}
{% endblock javascripts %}