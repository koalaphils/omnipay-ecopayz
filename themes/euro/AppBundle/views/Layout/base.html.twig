<!DOCTYPE html>
<html>
    <head lang="{{ app.request.getLocale() }}">
        <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="A fully featured admin theme which can be used to build CRM, CMS, etc." />
        <meta name="author" content="Coderthemes" />

        <link rel="shortcut icon" href="{{ asset("assets/images/piwi-bo-favicon.ico") }}" />

        <title>{{ 'page.title.main'|trans({},'AppBundle') }} | {% block title %}{% endblock %}</title>

        {% block stylesheet_plugins %}{% endblock %}

        <link href="{{ asset("assets/plugins/datatables/jquery.dataTables.min.css") }}" rel="stylesheet" type="text/css"/>
        {# this file does not exist #}
        {#<link href="{{ asset("assets/plugins/datatables/dataTables.responsive.min.css") }}" rel="stylesheet" type="text/css"/>#}
        <link href="{{ asset("assets/plugins/datatables/buttons.bootstrap.min.css") }}" rel="stylesheet" type="text/css"/>
        <link href="{{ asset("assets/plugins/datatables/responsive.bootstrap.min.css") }}" rel="stylesheet" type="text/css"/>
        <link href="{{ asset("assets/plugins/datatables/dataTables.bootstrap.min.css") }}" rel="stylesheet" type="text/css"/>

        <link href="{{ asset("assets/plugins/multiselect/css/multi-select.css") }}"  rel="stylesheet" type="text/css" />
        <link href="{{ asset("assets/plugins/bootstrap-select/css/bootstrap-select.min.css") }}" rel="stylesheet" />
        <link href="{{ asset("assets/plugins/select2/css/select2.css") }}" rel="stylesheet" />
        <link href="{{ asset("assets/plugins/bootstrap-tagsinput/css/bootstrap-tagsinput.css") }}" rel="stylesheet" />
        <link href="{{ asset("assets/plugins/switchery/css/switchery.min.css") }}" rel="stylesheet" />

        <link href="{{ asset("assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css") }}" rel="stylesheet"/>
        <link href="{{ asset("assets/plugins/bootstrap-daterangepicker/daterangepicker.css") }}" rel="stylesheet"/>

        <link href="{{ asset("assets/plugins/custombox/css/custombox.css") }}" rel="stylesheet">

        <link rel='stylesheet' href='{{ asset("assets/plugins/bootstrap-select/css/bootstrap-select.min.css") }}' />
        {% stylesheets
            "assets/plugins/bootstrap-sweetalert/sweetalert.css"
            "assets/css/bootstrap.min.css"
            "assets/css/core.css"
            "assets/css/components.css"
            "assets/css/icons.css"
            "assets/css/pages.css"
            "assets/css/responsive.css"
            "bundles/app/css/media_library.css"
            filter='cssrewrite'
        -%}
            <link rel="stylesheet" href="{{ asset_url }}" type="text/css" />
        {%- endstylesheets %}

        {% block stylesheets %}{% endblock %}

        <link rel="stylesheet" href="{{ asset("assets/css/custom.css") }}"/>

        <style type="text/css" rel="stylesheet">
            .has-error .select2-container,
            .has-error .bootstrap-select > button {
                border: 1px solid #a94442 !important;
                border-radius: 4px;
            }

            #zendeskChat-menu {
                min-height: 500px;
                min-width: 700px;
            }
            #zendeskChat-menu #zendeskChat {
                min-height: 600px;
                position: relative;
                width: 100%;
                border: 0px;
            }
            .table-action-btn {
                color: #98a6ad;
                display: inline-block;
                width: 28px;
                border-radius: 50%;
                text-align: center;
                line-height: 24px;
                font-size: 20px;
            }
            .select2-container .select2-selection--single .select2-selection__clear {
                width: 34px;
                text-align: center;
                margin-right: 14px;
            }
            .select2-container .select2-selection--single .select2-selection__clear:hover {
                background-color: #f05050 !important;
                border: 1px solid #f05050 !important;
            }
            .l-h-30 {
                line-height: 30px !important;
            }

            .p-5 {
                padding: 5px;
            }

            .p-r-50 {
                padding-right: 50px;
            }
            .m-l-0 {
                margin-left: 0px;
            }
            .m-r-0 {
                margin-right: 0px;
            }

            .b-r-1 {
                border-right-width: 1px;
            }

            .inline-block {
                display: inline-block !important;
            }

            .ztable_colvis_btn .bs-caret {
                display: none;
            }

            .notification-list .media-body {
                margin-left: 0;
            }
        </style>

        <!-- HTML5 Shiv and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="{{ asset("assets/js/modernizr.min.js") }}" ></script>
    </head>

    <body class="{% block bodyClass  %}fixed-left{% endblock %}">
        {% block body -%}
        <!-- Begin page -->
        <div id="wrapper">
            <!-- Top Bar Start -->
            <div class="topbar">
                <!-- LOGO -->
                <div class="topbar-left">
                    <div class="text-center">
                        <!--a href="{{ path('app.dashboard_page') }}" class="logo"><i class="icon-magnet icon-c-logo"></i><span>Superm<i class="md md-album"></i><i class="md md-album"></i>n</span></a-->
                        <!-- Image Logo here -->
                        <a href="{{ path('app.dashboard_page') }}" class="logo">
                            <i class="icon-c-logo"><img src="{{ asset("assets/images/piwi-bo-favicon.ico") }}" height="20"/> </i>
                            <span><img src="{{ asset("assets/images/acc66_logo.png") }}" height="25"/></span>
                        </a>
                    </div>
                </div>
                {% include 'AppBundle:Layout:header-menu.html.twig' %}
            </div>

            {% include 'AppBundle:Layout:side-menu-v2.html.twig' %}

            <div class="content-page">
                <!-- Start content -->
                <div class="content">
                    <div class="container">
                        {% block content -%}
                            <div class="row">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="page-header-2">
                                            {% block pageHeaderExtra %}{% endblock pageHeaderExtra %}
                                            <h4 class="page-title">{% block pageTitle %}{% endblock %}</h4>
                                            <ol class="breadcrumb">
                                                {% block breadcrumb %}{% endblock %}
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                {% block pageOuter -%}
                                <div class="row">
                                    {% block page -%}{%- endblock page %}
                                </div>
                                {%- endblock pageOuter %}
                            </div>
                        {%- endblock content %}
                    </div>

                    <footer class="footer text-right">
                        Â© {{ "now"|date("Y") }}. {{ 'layout.All rights reserved'|trans({},"AppBundle") }}.
                   </footer>
                </div>
            </div>
        </div>

        <!-- Floating Widgets -->
        {% if is_granted('ROLE_TRANSACTION_CREATE') %}
        <div class="float-sm">
          <div class="fl-fl float-widgets">
            <i class="widgets-holder fa fa-money"></i>
              <ul>
                <a href="{{ path("transaction.create_page", {'type': 'deposit'}) }}"><li>Deposit</li></a>
                <a href="{{ path("transaction.create_page", {'type': 'withdraw'}) }}"><li>Withdrawal</li></a>
              </ul>
          </div>
        </div>
        {% endif %}


        {%- endblock %}

        {% block modals %}
        {% endblock modals %}

        {% include "AppBundle:Layout:media_library.html.twig" %}
        <!-- END wrapper -->

        <script type="text/javascript" src="{{ asset('assets/plugins/lodash/lodash.js') }}"></script>
        <script type="text/javascript">
            var resizefunc = [];
            window.lodash = _;
        </script>
        {% javascripts
            "assets/js/decimal.min.js"
            "assets/js/jquery.min.js"
            "assets/js/bootstrap.min.js"
            "assets/js/detect.js"
            "assets/js/fastclick.js"
            "assets/js/jquery.slimscroll.js"
            "assets/js/jquery.blockUI.js"
            "assets/js/waves.js"
            "assets/js/wow.min.js"
            "assets/js/jquery.nicescroll.js"
            "assets/js/jquery.scrollTo.min.js"
            "assets/plugins/moment/moment.js"
            "assets/plugins/notifyjs/js/notify.js"
            "assets/plugins/notifications/notify-metro.js"
            "assets/plugins/bootstrap-sweetalert/sweetalert.min.js"

            "bundles/app/js/date.js"
            "bundles/app/js/media_library.js"
        -%}
            <script type="text/javascript" src="{{ asset_url }}"></script>
        {%- endjavascripts %}
        <script type="text/javascript" src="{{ asset('assets/plugins/moment/moment-timezone.js') }}"></script>
        <script>
            moment.tz.setDefault("{{ "now"|date("e") }}");
            var topics = {
                'memberCreated': "{{ constant('TransactionBundle\\WebsocketTopics::TOPIC_CUSTOMER_CREATED') }}",
                'productRequested': "{{ constant('WebSocketBundle\\Topics::TOPIC_MEMBER_PRODUCT_REQUESTED') }}"
            };
        </script>
        <script type='text/javascript' src="{{ asset('assets/plugins/dotdotdot/jquery.dotdotdot-3.2.2.js') }}"></script>
        {% block javascript_plugins %}{% endblock %}
        {% javascripts
            "assets/js/jquery.core.js"
            "assets/js/jquery.app.js"
        %}
        <script type="text/javascript" src="{{ asset_url }}"></script>

        <script>
            var websocketUrl = "{{ parameter("websocket.url") }}";
            var websocketRealm = "{{ parameter("websocket.realm") }}";
            var websocketJwt = "{% if jwt is defined %}{{ jwt }}{% endif %}";
        </script>

        {% endjavascripts %}
        <script type="text/javascript" src="{{ asset('bundles/app/js/cms_core.js') }}"></script>
        <script type="text/javascript" src="{{ asset('assets/plugins/bootstrap-select/js/bootstrap-select.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('assets/plugins/autobahn/autobahn.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/app/js/xml.js') }}"></script>
        <script type="text/javascript">
            var Global = new function () {
                this.dateFormat = phpjs_dateFormat("{{ setting('dateFormat')|e("js") }}");
                this.dateTimeFormat = phpjs_dateFormat("{{ setting('dateTimeFormat')|e("js") }}");
                this.dummyTransactionUrl = "{{ path('transaction.update_page', {'type': '__type__', 'id': '__id__' }) }}";
                this.dummyCustomerProfileUrl = "{{ path('member.update_page', {'id': '__id__', 'activeTab': '__activeTab__' }) }}";
                this.links = {
                    user: {
                        'preferences_save': '{{ path('user.preferences_save') }}'
                    }
                };
                this.transaction = {
                    'type': {
                        'deposit': 1,
                        'withdraw': 2,
                        'transfer': 3,
                        'p2ptransfer': 5,
                        'dwl': 6
                    },
                    'reversed': {
                        'deposit': 'deposit',
                        'withdraw': 'withdraw',
                        'transfer': 'transfer',
                        'p2ptransfer': 'p2p_transfer',
                        'dwl': 'dwl'
                    }
                };
                this.dwl = {
                    'status_groups': ['uploaded', 'uploading', 'submiting', 'submited'],
                    'status': {
                        'uploaded': {'value': 1, 'group': 'uploading'},
                        'processing': {'value': 2, 'group': 'uploading'},
                        'processed': {'value': 3, 'group': 'uploaded'},
                        'submited': {'value': 4, 'group': 'submiting'},
                        'transacting': {'value': 5, 'group': 'submiting'},
                        'completed': {'value': 6, 'group': 'submited'}
                    }
                };
                this.variables = {
                    'indexNotFound': -1
                };
                this.customer = {
                    'kyc' : {
                        'verified': {'value' : 1},
                        'unverified':{'value' : 0}
                    },
                    'status' : {
                        'enabled' : {'value' : 'enabled'},
                        'registered' : {'value' : 'registered'},
                        'suspended' : {'value' : 'suspended'}
                    }
                };
                this.gateway = {
                    'status' : {
                        'enabled' : {'value' : 1},
                        'suspended' : {'value' : 0}
                    },
                    'type' : {
                        'deposit' : { 'value' : 1},
                        'withdraw' : { 'value' : 2},
                        'transfer' : {'value' : 3}
                    },
                    'transaction_status': {
                        'pending' : { 'value' : 1},
                        'approved' : { 'value' : 2},
                        'voided' : { 'value' : 3}
                    }
                };
                this.user = {
                    'status' : {
                        'active' : {'value' : 1},
                        'suspended' : {'value' : 0}
                    }
                };
                this.audit = {
                    'operations' : {
                        'create': {"value": 1},
                        'update': {"value": 2},
                        'delete': {"value": 3},
                        'login': {"value": 4},
                        'logout': {"value": 5}
                    },
                     'categories' : {
                        'bonus': {"value": 1},
                        'country': {"value": 2},
                        'currency': {"value": 3},
                        'customer': {"value": 4},
                        'customerGroup': {"value": 5},
                        'dwl': {"value": 6},
                        'gateway': {"value": 7},
                        'gatewayTransaction': {"value": 8},
                        'notice': {"value": 9},
                        'paymentOption': {"value": 10},
                        'product': {"value": 11},
                        'deposit': {"value": 12},
                        'user': {"value": 13},
                        'userGroup': {"value": 14},
                        'login': {"value": 15},
                        'logout': {"value": 16},
                        'customerProduct': {"value": 17},
                        'customerPaymentOption': {"value": 18},
                        'withdrawal': {"value": 20},
                        'transfer': {"value": 21},
                        'p2pTransfer': {"value": 22},
                        'cDwl': {'value': 23},
                        'bet': {'value': 24},
                        'transactionBonus': {'value': 25},
                        'memberBanner': {'value': 27},
                        'memberWebsite': {'value': 28},
                        'memberReferralName': {'value': 29},
                        'bannerImage': {'value': 30},
                        'debitAdjustment': {'value': 34},
                        'creditAdjustment': {'value': 35}
                    }
                };

                this.commmission = {
                    'status' : {
                        'successfulComputation': {{ constant('DbBundle\\Entity\\CommissionPeriod::STATUS_SUCCESSFULL_COMPUTATION') }},
                        'successfulPayout': {{ constant('DbBundle\\Entity\\CommissionPeriod::STATUS_SUCCESSFULL_PAYOUT') }}
                    }
                };
            };
            Decimal.set({ precision: 65, rounding: Decimal.ROUND_DOWN });
            $(function() {
                // Startup Flash Notification
                {% for flashNotification in app.session.flashbag.get('notifications') %}
                notification('{{ flashNotification.title }}', '{{ flashNotification.message }}', '{{ flashNotification.type|default('custom') }}');
                {% endfor %}

                $(".ellipsis").dotdotdot({
                    wrap: 'letter'
                });
            });
        </script>


        {#
            Start from here -- This need to move to other pages, that needs this scripts.
            Since the purpose of this is for dashboard
        #}
        <script src="{{ asset("assets/plugins/datatables/jquery.dataTables.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/dataTables.bootstrap.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/dataTables.buttons.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/buttons.bootstrap.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/buttons.html5.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/buttons.print.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/dataTables.responsive.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/datatables/responsive.bootstrap.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/pages/datatables.init.js") }}" type="text/javascript"></script>

        <script src="{{ asset("assets/plugins/multiselect/js/jquery.multi-select.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/jquery-quicksearch/jquery.quicksearch.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/select2/js/select2.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/bootstrap-maxlength/bootstrap-maxlength.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/bootstrap-select/js/bootstrap-select.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/switchery/js/switchery.min.js") }}" type="text/javascript"></script>

     	<script src="{{ asset("assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/bootstrap-daterangepicker/daterangepicker.js") }}" type="text/javascript"></script>

        <script src="{{ asset("assets/plugins/custombox/js/custombox.min.js") }}" type="text/javascript"></script>
        <script src="{{ asset("assets/plugins/custombox/js/legacy.min.js") }}" type="text/javascript"></script>

        {{ asset_render('js', 'default') }}

        <script>
            TableManageButtons.init();
        </script>
        {# Ends Here #}

        <script type="text/javascript">
            MediaLibrary.init({
                'modal': "#media-library"
            });

            var statuses = {{ setting('transaction.status', true)|raw('js') }};
            var sortedStatuses = [];

            function generateStatusTree(status)
            {
                if (sortedStatuses.indexOf(status) === -1) {
                    sortedStatuses.push(status);
                }
                if (typeof statuses[status].actions != 'undefined') {
                    var tree = [];
                    for (var i in statuses[status].actions) {
                        tree.push(generateStatusTree(statuses[status].actions[i].status));
                    }
                } else {
                    var tree = status;
                }

                return tree;
            }

            $(function () {
                generateStatusTree(1);
                getCurrentTransactionCount();
                getNotificationListCount();
            });

            function getCurrentTransactionCount()
            {
                $.ajax({
                    'url': '{{ path('transaction.count_status') }}',
                    'beforeSend': function (xhr, ) {
                        for (var i in sortedStatuses) {
                            var status = statuses[sortedStatuses[i]];
                            generateStatus(sortedStatuses[i], status.label, '<i class="fa fa-spinner fa-spin"></i>');
                        }
                        generateStatus('voided', 'Voided', '<i class="fa fa-spinner fa-spin"></i>');
                    },
                    'success': function (data) {
                        for (var i in sortedStatuses) {
                            var status = statuses[sortedStatuses[i]];
                            generateStatus(sortedStatuses[i], status.label, data["status_" + sortedStatuses[i]]);
                        }

                        generateStatus('voided', 'Voided', data["status_voided"]);
                    }
                });
            }

            function generateStatus(id, label, counter) {
                var template = '<li class="status-counter"><a href="#" class="waves-effect waves-light">'
                    + '<span class="status-process" data-key="label"></span>:&nbsp;'
                    + '<strong class="status-process" data-key="counter">0</strong></a></li>';

                var statusElem = document.getElementById('statusCounter_' + id);
                if (statusElem === null) {
                    statusElem = $(template);
                    $('#statusLabel').append(statusElem);
                } else {
                    statusElem = $(statusElem);
                }
                statusElem.find('[data-key="label"]').html(label);
                statusElem.find('[data-key="counter"]').html(counter);
                statusElem.attr('id', 'statusCounter_' + id);
            }

            function getNotificationListCount() {
                $.ajax({
                    'url': '{{ path('app.notification.list') }}',
                    'success': function (data) {
                        iterateDataNotification(data);
                    }
                });
            }

            var iterateDataNotification = function (data) {
                var counter = 0;

                for (var i in data.list) {

                    var creationDate = new Date(data.list[i].createdAt.date);
                    var lastRead = new Date(data.lastRead.date);
                    var notifStatus = 'read';
                    var icon = '<i class="icon-envelope-open"></i>';
                    var url = '';
                    var title = '';
                    var message = '';

                    if (creationDate > lastRead) {
                        notifStatus = 'unread';
                        icon = '<i class="ti-email"></i>';
                        counter++;
                    }

                    if (data.list[i].notificationType === 'transaction') {
                        switch (data.list[i].type) {
                            case(Global.transaction.type.deposit):
                                var transactionType = Global.transaction.reversed.deposit;
                                break;
                            case(Global.transaction.type.withdraw):
                                var transactionType = Global.transaction.reversed.withdraw;
                                break;
                            case(Global.transaction.type.transfer):
                                var transactionType = Global.transaction.reversed.transfer;
                                break;
                            case(Global.transaction.type.p2ptransfer):
                                var transactionType = Global.transaction.reversed.p2ptransfer;
                                break;
                        }

                        url = Global.dummyTransactionUrl.replace('/__type__', '/'+ transactionType).replace('/__id__', '/'+ data.list[i].id);
                        title = transactionType +' TRANSACTION';
                        message = data.list[i].number +' '+ transactionType +' was requested.';
                    } else if (data.list[i].notificationType === 'customer') {
                        url = Global.dummyCustomerProfileUrl.replace('/__id__', '/'+ data.list[i].id).replace('/__activeTab__', '/profile');
                        title = 'MEMBER CREATED';
                        if (typeof data.list[i].fullName !== 'undefined' && data.list[i].fullName !== '') {
                            message = data.list[i].fullName +' was created.';
                        } else {
                            message = data.list[i].fName + ' '+ data.list[i].lName +' was created.';
                        }
                    } else if (data.list[i].notificationType == 'requestProduct') {
                        var details = data.list[i];

                        url = Global.dummyCustomerProfileUrl.replace('/__id__', '/'+ details.customer.id).replace('/__activeTab__', '/product');
                        title = 'PRODUCT REQUEST';
                        message = 'Product ' + details.product.name + ' has been added. (' + details.customer.fullName + ')';
                    }

                    var htmlContent = '<a href="'+ url +'" class="date-created list-group-item '+ notifStatus +'" data-date="'+ creationDate +'">'
                        + '<div class="media"><div class="media-body">'
                        + '<h5 class="media-heading">' + title.toUpperCase() +'</h5>'
                        + '<p class="m-0"><small>'+ message +' '+ icon +'</small></p>'
                        + '</div></div></a>';

                    $('li .notification-list').append(htmlContent);

                    if(counter) {
                        $('.notification-counter').html(counter);
                    }

                    i++;
                }
            };

            $('#read-notification').on('click', function () {
                $.ajax({
                    'url': '{{ path('app.notification.save_last_read') }}',
                    'success': function (data) {
                        if (!data.error) {
                            $('.notification-counter').html('');
                            $('li .notification-list a').removeClass('date-created list-group-item unread').addClass('date-created list-group-item read');
                        }
                    }
                });
            });

        </script>

        {% block javascripts -%}{%- endblock %}
        <script type="text/javascript">
            function websocketOnOpen(session) {
                $(function () {
                    $(document).trigger('onWebsocketOpen', [session]);
                });
            }
        </script>
        <script type="text/javascript" src="{{ asset('bundles/websocket/js/websocket_v2.js') }}"></script>
    </body>
</html>
