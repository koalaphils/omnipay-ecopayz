{% extends 'AppBundle:Widget:Page/form.html.twig' %}

{% block update_revenueShareForm_container %}
    <div id="{{ block_id }}" class="modal fade" aria-hidden="true">
    {{ widget_render_block(widget, 'widget') }}
    </div>
{% endblock update_revenueShareForm_container %}

{% block update_revenueShareForm_javascript %}
    {{ widget_render_block(widget, 'javascript') }}
    <script type='text/javascript'>
        $(function () {
        	$('#{{ id }}_container').on('show.bs.modal', function () {
                var data = $(this).data('revenueShare');
                if ((data.revenueShare.settings !== null) && (data.revenueShare.settings.length != 0))
                {
                    data.revenueShare.settings.forEach((settings, index) => {
                        document.getElementById("btn"+ "{{id}}" +"_data_revenueShareSettingsAdd").click();
                        $('#{{id}}_data_revenueShareSettings_' + index + '_min').val(settings.min);
                        $('#{{id}}_data_revenueShareSettings_' + index + '_max').val(settings.max);
                        $('#{{id}}_data_revenueShareSettings_' + index + '_percentage').val(settings.percentage);
                    });
                } else {
                    document.getElementById("btn"+ "{{id}}" +"_data_revenueShareSettingsAdd").click();
                }

                $('#{{ form.productId.vars.id }}').val(data.productId);
                $('#{{ form.productName.vars.id }}').val(data.productName);
                $('#{{ form.resourceId.vars.id }}').val(data.revenueShare.resource_id);
            });

            $('#{{ form.vars.id }}').on('form.success', function (e, data) { 
                $('#update_revenueShareForm_container').find("tr").remove();
                $('#{{ id }}_container').modal('hide');
            });
        });
    </script>
{% endblock update_revenueShareForm_javascript %}

{% block update_revenueShareForm_widget %}
    {{ form_start(form) }}
    <div class='modal-dialog modal-responsive'>
        <div class='modal-content p-0 b-0'>
            <div class="panel panel-color panel-inverse">
                <div class="panel-heading"><h3 class="panel-title">Update {{form.productName.vars.value}} Revenue Share</h3></div>
                {% for fieldName in widget.getGroup('Default') %}
                    {{ form_row(form[fieldName]) }}
                {% endfor %}
                <div class="hide">
                    {% for fieldName in widget.getGroup('Buttons') %}
                        {{ form_row(form[fieldName]) }}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {{ form_end(form) }}
{% endblock update_revenueShareForm_widget %}

{%- block repeatable_javascript -%}
    {% for child in form -%}
        {{- form_javascript(child) -}}
    {%- endfor %}
    <script type="text/javascript" id="{{ id }}_javascript">
        $(function () {
            var {{ id }}_prototype = "{{ form_row(form.vars.prototype)|escape('js') }}";
            var {{ id }}_index = 0;
            if (!isNaN(parseInt($('#{{ id }} .record:last').data('index')))) {
                var {{ id }}_index = parseInt($('#{{ id }} .record:last').data('index')) + 1;
            }

            $('#{{ id }}').on('click', '.btn-remove', function () {
                var target = $(this).data('target');
                $(target).remove();
            });

            $('#{{ id }}').data('initialState', $('#{{ id }}').html());

            $('#btn{{ id }}Add').click(function () {
                var prototype = {{ id }}_prototype;
                prototype = prototype.replace(/{{ form.vars.prototype.vars.name }}/g, {{ id }}_index,);
                var elem = $(prototype);
                $('#{{ id }}').append(elem);
                {{ id }}_index += 1;
            });

            $('.btn-inverse').click(function (e) {
                $('#{{ id }}').find("tr").remove();
                {{ id }}_index = 0;
            });

            $('#update_revenueShareForm_data').on('form.success', function (e, data) {
                {{ id }}_index = 0;
            });
        });
    </script>
{% endblock repeatable_javascript %}

{% block repeatable_row -%}
    <div id="updateRevShare" class='panel-body p-20'>
        <table class="table table-striped table-bordered dt-responsive nowrap dataTable no-footer dtr-inline">
            <thead>
                <tr>
                    <th>Customer W/L</th>
                    <th>Revenue Share %</th>
                </tr>
            </thead>
            <tbody id="{{ id }}" class="repeatable-field">
                {{- form_widget(form) -}}
            </tbody>
        </table>
    </div>

    <div id="updateRevShare" class='panel-footer'>
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-primary btn-sm" id="btn{{ id }}Add" type="button">
                    <i class="fa fa-plus"></i>
                    {% if form.vars.properties.addLabel|default('') != '' %}
                        {{ form.vars.properties.addLabel }}
                    {% endif %}
                </button>
            </div>
            <div class="col-md-6 text-right">
                <button type="submit" class="btn btn-success btn-sm" type="button">Update</button>
                <button class="btn btn-inverse btn-sm" data-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
{%- endblock repeatable_row %}

{% block repeatableRecord_row %}
    <tr id="{{ id }}" data-index="{{ name }}">
        <td>
            <div class="flex-container">
                <div class="flex-6">
                    <div class="form-group {% if (not compound or force_error|default(false)) and not valid %} has-error{% endif %}">
                        <div class="input-group">
                            <span class="input-group-addon">Min.</span>
                            {{ form_row(form.min)}}                        
                            <span class="input-group-addon">EUR</span>
                        </div>
                        {{- form_errors(form) -}}
                    </div>
                </div>
                <div class="flex-1 revshare-sign">
                    <span>&#8804;</span>
                </div>
                <div class="flex-6">
                    <div class="form-group {% if (not compound or force_error|default(false)) and not valid %} has-error{% endif %}">
                        <div class="input-group">
                            <span class="input-group-addon">Max.</span>
                            {{ form_row(form.max)}}
                            <span class="input-group-addon">EUR</span>
                        </div>
                        {{- form_errors(form) -}}
                    </div>
                </div>
            </div>
        </td>
        <td>
            <div class="form-group {% if (not compound or force_error|default(false)) and not valid %} has-error{% endif %}">
                <div class="input-group">
                    {{ form_row(form.percentage)}}
                    <span class="input-group-addon">%</span>
                </div>
                {{- form_errors(form) -}}
            </div>
        </td>
        <td class="repeatable-actions p-b-10">
            <button class="btn btn-danger btn-xs pull-right btn-remove" data-target="#{{ id }}" type="button"><i class="fa fa-close"></i></button>
            <div class="clearfix"></div>
        </td>
    </tr>
{% endblock repeatableRecord_row %}

{% block form_row -%}
    {{- form_widget(form) -}}
{%- endblock form_row %}

{% block repeatable_widget -%}
    {% for recordChild in form %}
        {{ form_row(recordChild) }}
    {% endfor %}
{%- endblock repeatable_widget %}