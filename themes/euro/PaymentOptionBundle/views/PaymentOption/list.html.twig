{% extends 'AppBundle:Layout:base.html.twig' %}

{% block title %}{{ "page.title.list"|trans({},"PaymentOptionBundle") }}{% endblock %}

{% block stylesheets %}
    <!-- DataTables -->
    <link href="{{ asset('assets/plugins/datatables/jquery.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.colVis.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block pageTitle %}{{ "menus.PaymentOption"|trans({},"PaymentOptionBundle") }}{% endblock pageTitle %}

{% block pageHeaderExtra %}
    <div class="pull-right">
        {% if is_granted('ROLE_PAYMENTOPTION_CREATE') %}
        <a class="btn btn-primary waves-effect waves-light pull-right m-b-10" href="{{ path('paymentoption.create_page') }}"> <span><i class="ti-plus m-r-5"></i></span> {{ "Add Payment Option"|trans({}, 'PaymentOptionBundle') }}</a>
        {% endif %}
        <ul class="list-inline quicklinks font-13 font-normal text-right">
            {% if is_granted(['ROLE_TRANSACTION_VIEW' , 'ROLE_USER_VIEW']) %}
            <li>Quick Links:</li>
            {% endif %}
            {% if is_granted('ROLE_TRANSACTION_VIEW') %}
            <li><a href="{{ path("transaction.list_page") }}">{{ "Transaction History"|trans({}, 'PaymentOptionBundle') }}</a></li>|
            {% endif %}
            {% if is_granted('ROLE_USER_VIEW') %}
            <li><a href="{{ path("group.list_page") }}">{{ "User Group"|trans({}, 'PaymentOptionBundle') }}</a></li>
            {% endif %}
        </ul>
    </div>
{% endblock pageHeaderExtra %}

{% block breadcrumb -%}
    <li>{{ "breadcrumb.setting"|trans({},"AppBundle") }}</li>
    <li class="active">{{ "breadcrumb.list"|trans({},"PaymentOptionBundle") }}</li>
{%- endblock %}

{% block page %}
    <div class="col-sm-12">
        <div class="card-box">
            <div id="paymentOptions">
                <table id="datatable-responsive"
                    class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0"
                    width="100%">
                    <thead>
                        <tr>
                            <th data-priority="1">{{ "fields.code"|trans({}, "PaymentOptionBundle") }}</th>
                            <th>{{ "fields.name"|trans({}, "PaymentOptionBundle") }}</th>
                            <th>{{ "fields.status"|trans({}, "PaymentOptionBundle") }}</th>
                            <th data-priority="2">{{ "fields.action"|trans({}, "AppBundle") }}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </div>
    </div>
{% endblock page %}

{% block javascripts %}
    <script src="{{ asset('bundles/app/js/ZTable.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.bootstrap.js') }}"></script>

    <script src="{{ asset('assets/plugins/datatables/dataTables.buttons.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/vfs_fonts.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/buttons.html5.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.colVis.js') }}"></script>

    <script type="text/javascript">
        $(function(){
            $('#paymentOptions').list({
                'url': {
                    'list': '{{ path("paymentoption.search") }}'
                },
                'rowOnclick': function (e, zTable) {
                    dataTable = zTable.dataTable.api();
                    e.preventDefault();
                    var currentRow = $(e.target).parents('tr');
                    if (currentRow.hasClass('child')) {
                        currentRow = currentRow.prev();
                    }
                    var data = dataTable.row(currentRow).data() ;
                    var anchor = $(e.target).closest('a');
                    var mode = anchor.attr('action');

                    if (mode == 'suspend') {
                        suspendPaymentOption(data);
                    } else if (mode == 'activate') {
                        activatePaymentOption(data);
                    }
                }
            });
        });
        
        function suspendPaymentOption(paymentOption)
        {
            confirm2('Are you sure you want to suspend '+ paymentOption.name, 'Suspend Payment Option', {
                'type': null,
                'confirmButtonClass': 'btn-success btn-md',
                'confirmButtonText': 'Yes',
                'cancelButtonClass': 'btn-inverse btn-md',
                'cancelButtonText': 'Cancel',
                'html': true,
                'showLoaderOnConfirm': true
            }, function(isSuspended) {
                if(isSuspended) {
                    $.ajax({
                        url : "{{ path('paymentoption.suspend') }}",
                        globalAjaxComplete : false,
                        type: "POST",
                        dataType: "JSON",
                        data: {
                            "code": paymentOption.code
                        },
                        success : function (data) {
                            var notifications = data.__notifications || [];
                            swal({
                                'type': notifications.type,
                                'title': notifications.title,
                                'text': notifications.message
                            }, function() {
                                $('#paymentOptions').trigger('refresh');
                            });
                        }
                    });
                }
            });
        }

        function activatePaymentOption(paymentOption)
        {
            confirm2('Are you sure you want to activate '+ paymentOption.name, 'Activate Payment Option', {
                'type': null,
                'confirmButtonClass': 'btn-success btn-md',
                'confirmButtonText': 'Yes',
                'cancelButtonClass': 'btn-inverse btn-md',
                'cancelButtonText': 'Cancel',
                'html': true,
                'showLoaderOnConfirm': true
            }, function(isActivated) {
                if(isActivated) {
                    $.ajax({
                        url : "{{ path('paymentoption.activate') }}",
                        globalAjaxComplete : false,
                        type: "POST",
                        dataType: "JSON",
                        data: {
                            "code": paymentOption.code
                        },
                        'success': function (data) {
                            var notifications = data.__notifications || [];
                            swal({
                                'type': notifications.type,
                                'title': notifications.title,
                                'text': notifications.message
                            }, function() {
                                $('#paymentOptions').trigger('refresh');
                            });
                        }
                    });
                }
            });
        }
        
        (function($){
            $.fn.list = function(options, params){
                var settings = options;
                params = params || [];
                return this.each(function(){
                    var elem = $(this);
                    settings = $.extend(true,_defaults(),options);
                    init(elem, settings);
                });
            };

            function init(elem, settings) {
                initTable(elem, settings);
            }

            function initTable(elem, settings) {
                var table = $(elem).find('table');
                var listUrl = settings.url.list;
                var userPreferences = {{ app.user.getPreference('ui.paymentOptions.list.column.visibility')|json_encode()|raw }};
                var dataTable = new ZTable('#paymentOptions',  {
                    'ajax': {
                        'url': settings.url.list,
                        'data': function (data, dataTable) {
                            return {
                                'search': data.filters.search,
                                'length': data.length,
                                'start': dataTable.start,
                                'datatable': true,
                                'route': true,
                                'draw': dataTable.draw,
                                'order': data.order
                            };
                        },
                        'dataFilter': function (str) {
                            return str;
                        }
                    },
                    'colvis': {
                        'hidden': function () {
                            var hidden = [];
                            for (var i in userPreferences) {
                                if (userPreferences[i] == 'false') {
                                    hidden.push(eval(i));
                                }
                            }
                            return hidden;
                        },

                        'exclude': ['code', 'name']
                    },
                    'columns': settings.columns,
                    'ordering': true,
                    'attrs': {
                        'colvisButton' : {
                            'data-style': 'btn-primary'
                        }
                    }

                });

                $(table).on('click', 'td a.active-state-action', function(e) {
                    settings.rowOnclick(e, dataTable);
                });

                $('#paymentOptions table').on('draw.dt', function () {
                    dataTable.dataTable.api().columns.adjust().responsive.recalc();
                });

                $(elem).on('refresh', { "dataTable": dataTable}, function(event){
                    dataTable.reloadTable();
                });
            }

            function _defaults() {
                return {
                    'columns': [
                        {
                            'data': 'code',
                            'name': 'code',
                            'defaultContent': ''
                        },
                        {
                            'data': 'name',
                            'name': 'name',
                            'defaultContent': ''
                        },
                        {
                            'data': 'is_active',
                            'name': 'isActive',
                            'defaultContent': '',
                            'render': function(data) {
                                
                                return (data) ? "Enabled" : "Suspended";
                            }
                        },
                        {
                            'data': 'data',
                            'name': 'action',
                            'defaultContent': '',
                            'render': function(data, text, full) {
                                var action = "<a class='btn btn-primary waves-effect waves-light btn-xs' title='Edit Payment Option' href='" + full._link.page + "'>Edit</a>";
                                var suspend = "<a action='suspend' class='btn btn-danger waves-effect waves-light m-r-10 btn-xs active-state-action' title='Suspend Payment Option'>Suspend</a>";
                                var activate = "<a action='activate' title='Activate Payment Option' class='btn btn-default waves-effect waves-light btn-xs active-state-action'>Activate</a>&nbsp;";
                                
                                if (full.is_active) {
                                    action = action + '&nbsp;' + suspend;
                                } else {
                                    action = action + '&nbsp;' + activate;
                                }
                                
                                return action;
                            }
                        }
                    ]
                };
            }
        })(jQuery);
    </script>

{% endblock %}