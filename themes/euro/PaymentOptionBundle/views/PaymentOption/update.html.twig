{% extends 'AppBundle:Layout:base.html.twig' %}

{% form_theme form "PaymentOptionBundle:Form:paymentOption.html.twig" %}

{% block title %}{{ "page.title.update"|trans({},"PaymentOptionBundle") }}{% endblock %}

{% block stylesheet_plugins %}
    {{ form_assetcss(form) }}
    {{ form_assetcss(configurationForm) }}
{% endblock %}

{% block stylesheets %}
    {{ form_stylesheet(form) }}
    {{ form_stylesheet(configurationForm) }}
{% endblock stylesheets %}

{% block javascript_plugins %}
    {{ form_assetjs(form) }}
    {{ form_assetjs(configurationForm) }}
{% endblock %}

{% block pageTitle %}{{ "page.Update Payment Option"|trans({}, 'PaymentOptionBundle') }}{% endblock pageTitle %}

{% block pageHeaderExtra %}
    <div class="pull-right">
        {% if is_granted('ROLE_PAYMENTOPTION_VIEW') %}
            <a class="btn btn-inverse waves-effect waves-light pull-right m-b-10" href="{{ path("paymentoption.list_page") }}"> <span><i class="ti-arrow-left m-r-5"></i></span> {{ "Back to Payment Option List"|trans({}, 'PaymentOptionBundle') }}</a>
        {% endif %}
        <ul class="list-inline quicklinks font-13 font-normal text-right">
            {% if is_granted(['ROLE_COUNTRY_VIEW' , 'ROLE_TRANSACTION_VIEW' , 'ROLE_USER_VIEW']) %}
                <li>Quick Links:</li>
            {% endif %}
            {% if is_granted('ROLE_COUNTRY_VIEW') %}
                <li><a href="{{ path('paymentoption.create_page') }}">{{ "Add Payment Option"|trans({}, 'PaymentOptionBundle') }}</a></li>|
            {% endif %}
            {% if is_granted('ROLE_TRANSACTION_VIEW') %}
                <li><a href="{{ path("transaction.list_page") }}">{{ "Transaction History"|trans({}, 'PaymentOptionBundle') }}</a></li>|
            {% endif %}
            {% if is_granted('ROLE_USER_VIEW') %}
                <li><a href="{{ path("group.list_page") }}">{{ "User Group"|trans({}, 'PaymentOptionBundle') }}</a></li>
            {% endif %}
        </ul>
    </div>
{% endblock pageHeaderExtra %}

{% block breadcrumb -%}
    <li>{{ "breadcrumb.setting"|trans({},"AppBundle") }}</li>
    <li>
        <a href="{{ path("paymentoption.list_page") }}">{{ "breadcrumb.list"|trans({},"PaymentOptionBundle") }}</a>
    </li>
    <li class="active">
        {{ "breadcrumb.update"|trans({},"PaymentOptionBundle") }}
    </li>
{%- endblock %}

{% block page %}
    <div class="col-sm-12">
        <ul class="nav nav-tabs">
            <li class="li-tab active">
                <a href="#paymentOption" data-toggle="tab" class="paymentOption-tab">
                    <span class="hidden-xs">Payment Option</span>
                </a>
            </li>
            <li class="li-tab">
                <a href="#configuration" data-toggle="tab" class="paymentOption-tab">
                    <span class="hidden-xs">Configuration</span>
                </a>
            </li>
        </ul>
        <div class="tab-content bg-muted">
            <div class="tab-pane active" id="paymentOption">
                {{ form_start(form) }}
                <div class="card-box">
                    <div class="row">
                        {% if (form.vars.data and form.vars.data.code) %}
                            {% block _paymentOption_code_widget %}
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <div class="form-control">{{ form.vars.data.code }}</div>
                                    </div>
                                </div>
                            {% endblock _paymentOption_code_widget %}
                        {% endif %}
                        {{ form_row(form.name) }}
                        {{ form_row(form.paymentMode) }}
                        {{ form_row(form.sort) }}
                        {{ form_row(form.isActive) }}
                        {{ form_row(form.autoDecline) }}
                        {{ form_row(form.fields) }}
                        {{ form_row(form.image) }}
                    </div>
                </div>

                <div class="card-box">
                    <div class="row">
                        <div class="col-md-12">
                            <button id="btnSave" type="submit" class="btn btn-success btn-actions">Save</button>
                        </div>
                    </div>
                </div>
                {{ form_end(form) }}
            </div>
            <div class="tab-pane" id="configuration">
                {{ block('configurationTab') }}
            </div>
        </div>
    </div>
{% endblock page %}

{% block configurationTab %}
    {{ form_start(configurationForm) }}
    <div class="card-box">
        <h4 class="m-t-0 header-title"><b>Auto Decline</b></h4>
        <div class="row">
            {{ form_row(configurationForm.autoDecline.interval) }}
            {{ form_row(configurationForm.autoDecline.status, {'attr': {'class': 'selectpicker'}}) }}
        </div>
    </div>
    <div class="card-box">
        <div class="row">
            <div class="col-md-12">
                <button type="submit" class="btn btn-success btn-actions">Save</button>
            </div>
        </div>
    </div>
    {{ form_end(configurationForm) }}
{% endblock configurationTab %}

{% block javascripts %}
    <script type="text/javascript" src="{{ absolute_url(asset('assets/plugins/jquery-form/jquery.form.min.js')) }}"></script>

    {{ form_javascript(form) }}
    {{ form_javascript(configurationForm) }}

    <script type="text/javascript">
        var locationHref = getLocation(window.location.href)
        var fieldPrototype = "{{- form_row(form.fields.vars.prototype)|e('js') -}}"
        var newId = {{ form.fields | length}}

        function goToDefaultUrlWhenInCorrectURL(href) {
            if (!href.pathname.match(/\/([A-Z]+)\/(.*)/)) {
                location.href = href.href + '/paymentOption'
            }
        }

        function getLocation(href) {
            var location = document.createElement("a")
            location.href = href

            if (location.host == "") {
                location.href = location.href
            }

            return location
        }

        function displayActiveTab() {
            var activeTab = '{{app.request.attributes.get('activeTab')}}'

            $('.nav-tabs a[href="#' +  activeTab + '"]').tab('show')
        }

        //goToDefaultUrlWhenInCorrectURL(locationHref)

        $(function() {
            displayActiveTab()

            $('.paymentOption-tab').click(function(e){
                e.preventDefault();
                var activeTabTab = $('.li-tab.active .paymentOption-tab').attr('href');
                var currentTab = $(activeTabTab + '.tab-pane');
                var newTab = $(this).attr('href');

                currentTab.removeClass('active');
                $('.li-tab.active').removeClass('active');

                $(this).closest('li').addClass('active');
                $($(this).attr('href') + '.tab-pane').addClass('active');
                history.pushState({}, null, newTab.replace("#",''));
            });

            $('#{{ form.vars.id }}').ajaxForm({
                'dataType': 'json',
                'success': function (data) {
                    if (data.success) {
                        notification('Saved', 'You have successfully saved payment option', 'success');
                    } else if (typeof data.errors !== 'undefined') {
                        for (var i in data.errors) {
                            var error = data.errors[i];
                            $('#' + error.formId)
                                .closest('.form-group').addClass('has-error')
                                .find('.help-block ul')
                                .append('<li>' + error.message + '</li>')
                        }
                    }
                },
                'complete': function (xhr, textStatus) {
                    $('.btn-actions').removeAttr('disabled')
                },
                'statusCode': {

                },
                'beforeSend': function (xhr) {
                    $('#{{ form.vars.id }}').find('.form-group').removeClass('has-error')
                    $('#{{ form.vars.id }}').find('.help-block ul li').remove()
                    $('.btn-actions').attr('disabled', 'disabled')
                }
            })

            $('#{{ configurationForm.vars.id }}').ajaxForm({
                dataType: 'json',
                success: function (data) {

                },
                complete: function (xhr, textStatus) {

                },
                beforeSend: function (xhr) {

                }
            })
        })
    </script>
{% endblock javascripts %}