{% extends 'AppBundle:Layout:base.html.twig' %}

{% block title %}{{ "page.title.request.product_password"|trans({},"MemberRequestBundle") }}{% endblock %}

{% block stylesheets %}
    <!-- DataTables -->
    <link href="{{ asset('assets/plugins/datatables/jquery.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.colVis.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/css/custom-memberRequest.css') }}" rel="stylesheet">
{% endblock %}

{% block pageTitle -%} {{ "menus.MemberRequest"|trans({},"MemberRequestBundle") }} {%- endblock pageTitle %}

{% block breadcrumb -%}
<li>{{ "breadcrumb.memberRequest"|trans({},"AppBundle") }}</li>
{%- endblock breadcrumb %}

{% block pageHeaderExtra %}
<div class="pull-right">
    <a class="btn btn-inverse waves-effect waves-light pull-right m-b-10" href="{{ path("member_request.pending") }}">
        <i class="ti-arrow-left m-r-10"></i>{{ "Back to Pending List"|trans({}, 'MemberRequestBundle') }}
    </a>
    <ul class="list-inline quicklinks font-13 font-normal text-right">
        <li>Quick Links:</li>
        {% if is_granted('ROLE_MEMBER_REQUEST_VIEW') %}
        <li><a href="{{ path("member_request.pending") }}">Pending</a></li>|
        <li><a href="{{ path("member_request.history") }}">History</a></li>
        <li>&nbsp;</li>
        {% endif %}
    </ul>
</div>
{% endblock pageHeaderExtra %}

{% block page %}
  <div class="row">
    <div class="col-md-12">
      <div class="col-md-3">
        <div class="card-box" id="customer-container">
          <h4 class="m-t-0 header-title">Member</h4>
          <span class="form-control"> <i class="fa fa-user"></i> | {{memberRequest.getMember().getFullName()}} ({{memberRequest.getMember().getUser().getUsername()}})</span>
        </div>
      </div>
      {{ form_start(form) }}
      <div class="col-md-5">
        <div class="card-box">
          <div class="card-box">
            <div class="row">
                {{ form_row(form.number) }}
                {{ form_row(form.date) }}
            </div>
          </div>
          <div class="card-box">
            <h4 class="header-title m-b-10 m-t-0">Reset Product Password</h4>
            <div class="row">
                
                {% for key, child in form.subRequests.children%}
                    {{form_widget(child.children['member_product_id'])}}
                    
                    <div class="col-md-7 col-sm-7 col-xs-12">
                        <div class="form-group">
                            <div class="input-group">
                                <span class="input-group-addon"><label class="control-label required" for="Transaction_subTransactions_0_customerProduct">Product</label></span>
                                <input type="text" id="{{form.subRequests.vars.id}}_{{key}}_productUser" class="form-control" value="{{memberRequest.getMemberProductAndUserName(child.vars.value['member_product_id'])}}" readonly />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5 col-sm-5 col-xs-12 amount-col">
                        <div class="form-group">
                            <div class="input-group">
                                {{form_widget(child.children['password'])}}
                                <span class="input-group-btn">
                                    <button type="button" class="btn waves-effect waves-light btn-warning btn-copy-password"><i class="fa fa-copy"></i></button>
                                </span>
                            </div>
                            <div class="help-block">
                                <ul class="list-unstyled"></ul>
                            </div>
                        </div>
                    </div>
                {%endfor %}
                {% if form.generatePassword is defined %}
                    <div>
                        <div class="form-group">
                        {{ form_widget(form.generatePassword) }}
                        </div>
                    </div>
                {% endif %}
            </div>
          </div>
          <div class="card-box">
            <div class="row">
                <div class="col-sm-12">
                    {{ form_row(form.notes) }}
                </div>
            </div>
          </div>
          <div class="row">
              <div class="col-sm-12">
              {{ form_row(form.actions) }}
              </div>
          </div>
        </div>
      </div>
      {{ form_end(form) }}    
    </div>
  </div>
{% endblock page %}

{% block javascripts %}
<script src="{{ asset('bundles/transaction/js/transaction/form.js') }}"></script>
<script type="text/javascript" >
    $(function(){
        var requestStatus = {{memberRequest.getStatus()}};
        
        $('#{{ form.vars.id }}').form({
            'action': '{{ form.vars.action }}',
            'ajax': {
                'success': function (data) {
                    if (data.success) {
                        notification('Saved', 'You have successfully saved request', 'success');
                        setTimeout(function () {
                            window.location = window.location.href;
                        }, 1000);
                    } else if (typeof data.errors !== 'undefined') {
                        for (var i in data.errors) {
                            var error = data.errors[i];
                            $('#' + error.formId)
                                .closest('.form-group')
                                .addClass('has-error')
                                .find('.help-block ul')
                                .append('<li>' + error.message + '</li>');
                        }
                        notification('Validation Failed', 'Some fields are invalid', 'error');
                    }
                },
                'beforeSend': function (xhr, settings) {
                    $('#{{ form.vars.id }}').find('.form-group').removeClass('has-error');
                    $('#{{ form.vars.id }}').find('.help-block ul li').remove();
                    $('#btnSave').attr('disabled', 'disabled');
                },
                'complete': function (xhr, textStatus) {
                    $('#btnSave').removeAttr('disabled');
                }
            }
        });
        
        $('.btn-action').click(function () {     
            var submitButton = this;
            $('#{{ form.vars.id }}').trigger('form:submit', [submitButton]);
        });

        {% if form.generatePassword is defined %}
        var subRequestCount = {{form.subRequests.count()}};
        $("#{{ form.generatePassword.vars.id }}").click(function () {
            $.ajax({
                url : "{{ path('product.generate_password') -}}",
                globalAjaxComplete : false,
                type: "POST",
                dataType: "JSON",
                data: {'quantity': subRequestCount},
                success : function (data) {
                    if (data.status) {
                        var generatedPassword = data.result;
                        for (var i in generatedPassword){
                            $("#{{form.subRequests.vars.id}}_" + i + "_password").html(generatedPassword[i]);
                            $("#{{form.subRequests.vars.id}}_" + i + "_password").val(generatedPassword[i]);
                        }
                    }
                }
            });
        });
        {% endif %}
        
        $('.btn-copy-password').on('click',function(e) {
            var copyText = $(this).closest("div.input-group").find("input");
            copyText.select();
            document.execCommand('copy');
        });
    });
  </script>
{% endblock javascripts %}