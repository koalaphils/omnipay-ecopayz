{% extends 'TransactionBundle:Transaction:transaction.html.twig' %}

{% form_theme form with ["TransactionBundle:Transaction/Theme:script.html.twig", "TransactionBundle:Transaction/Theme:style.html.twig", "TransactionBundle:Transaction/Theme:form.html.twig", _self] %}

{% block breadcrumb -%}
    <li>
        <a href="{{ path("app.dashboard_page") }}">{{ "menus.Dashboard"|trans({},"AppBundle") }}</a>
    </li>
    <li>
        <a href="{{ path("transaction.list_page") }}">{{ "breadcrumb.list"|trans({},"TransactionBundle") }}</a>
    </li>
    <li class="active">{{ "menus.DWL"|trans({},"TransactionBundle") }}</li>
{%- endblock %}

{% block left_pane %}
    {{ block('customer') }}
    {{ block('paymentOption') }}
    {{ block('gateway') }}
    <div class="card-box">
        <h4 class="m-t-0 m-b-30">Daily Win Loss</h4>
        <div class="text-muted">
            <div class="row m-t-10">
                <div class="col-md-3 col-sm-3 col-xs-3 text-right"><b>Product:</b></div>
                <div class="col-md-8 col-sm-8 col-xs-8 m-l-15" >{{ dwl.product.name }}</div>
            </div>
            <div class="row m-t-10">
                <div class="col-md-3 col-sm-3 col-xs-3 text-right"><b>Currency:</b></div>
                <div class="col-md-8 col-sm-8 col-xs-8 m-l-15" >{{ dwl.currency.code }}</div>
            </div>
            <div class="row m-t-10">
                <div class="col-md-3 col-sm-3 col-xs-3 text-right"><b>Date:</b></div>
                <div class="col-md-8 col-sm-8 col-xs-8 m-l-15" >{{ dwl.date|date('M d, Y') }}</div>
            </div>
            <div class="row m-t-10">
                <div class="col-md-3 col-sm-3 col-xs-3 text-right"><b>Link:</b></div>
                <div class="col-md-8 col-sm-8 col-xs-8 m-l-15" >
                    <a href="{{ path('dwl.update_page', {'id': dwl.id}) }}" target="_blank">Go to DWL Records</a>
                </div>
            </div>
        </div>
    </div>
{% endblock left_pane %}

{% block customer %}
    <div class="card-box" id='customer-container'>
        <h4 class="m-t-0 m-b-30 header-title">{{ "Member"|trans({},'TransactionBundle') }}</h4>
        <div class="form-group {% if form.customer.vars.errors|length > 0 %} has-error {% endif %}">
            {{ form_widget(form.customer) }}
            {{ form_errors(form.customer) }}
        </div>

        <div class="text-muted">
            <div class="row m-t-10">
                <div class="col-md-3 col-sm-3 col-xs-3 text-right"><b>Username:</b></div>
                <div class="col-md-8 col-sm-8 col-xs-8 m-l-15 customer-data" data-field="user.username"></div>
            </div>
        </div>
    </div>
{% endblock customer %}

{% block gateway %}
    <div class="card-box hidden" id="gateway-container">
        <h4 class="m-t-0 m-b-30 header-title">{{ "Payment Gateway"|trans({},'TransactionBundle') }}</h4>
        <div class="form-group {% if form.gateway.vars.errors|length > 0 %} has-error {% endif %}">
            {{ form_widget(form.gateway, {'attr': {'disabled': 'disabled'}}) }}
            {{ form_errors(form.gateway) }}
        </div>
    </div>
{% endblock gateway %}

{% block middle_pane %}
    <div class="card-box">
        <div class="card-box">
            <div class="row">
                {{ form_row(form.number) }}
                {{ form_row(form.date) }}
                {{ form_row(form.currency) }}
            </div>
        </div>
        {{ form_row(form.subTransactions) }}
        {% if transaction.isDeposit() or transaction.isWithdrawal() %}
            <div class="card-box">
        {% else %}
            <div class="card-box hide">
        {% endif %}
                <div class="row">
                    {{ form_row(form.customerFee) }}
                    {{ form_row(form.companyFee) }}
                </div>
            </div>
        <div class="card-box hidden">
            <div class="row">
                {% if transaction.isEnd() and transaction.isVoided() %}
                    {{ form_row(form.notes, {'view': true}) }}
                {% else %}
                    {{ form_row(form.notes) }}
                {% endif %}
                {% if transaction.isDeclined() or transaction.isVoided() %}
                    {{ form_row(form.reasonToVoidOrDecline, {'view': true}) }}
                {% endif %}
            </div>
        </div>
        {% if form.actions.children | length > 0 %}
            <div class="row">
                {{ form_row(form.actions) }}
            </div>
        {% else %}
            {{ form_row(form.actions) }}
        {% endif %}
    </div>
{% endblock middle_pane %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        var products = null;
        function customerProductLoad(data) {
            products.clear();
            products.setProducts(data);

            {% for child in form.subTransactions.children -%}
            products.add({
                'type': '{{ child.vars.data.type }}',
                'customerProduct': '{{ child.vars.data.customerProduct.id|default(null) }}',
                'immutableCustomerProductData': '{{ child.vars.data.immutableCustomerProductData|default(null) }}',
                'amount': '{{ child.vars.data.amount }}',
                'enabled': {% if child.vars.view -%} false {%- else -%} true {%- endif -%},
                'errors': '{{ form_errors(child) }}'
            });
            {% else %}
            products.add({
                'type': 1,
                'customerProduct': null,
                'amount': 0,
                'enabled': true
            });
            {%- endfor %}

            $('#gateway-container').removeClass('hide');
            $('#payment-option-container').removeClass('hide');
        }

        $(function() {
            $('#{{ form.customer.vars.id }}').on('select2:select', function(event) {
                products.clear();
            });

            $('.btn-add-product').click(function() {
                products.add({
                    'type': 1,
                    'customerProduct': null,
                    'amount': 0,
                    'enabled': true
                });
            });

            products = new Products('deposit',{
                'prototype': '{{ form_row(form.subTransactions.vars.prototype)|e('js') }}',
                'elem': '#{{ form.subTransactions.vars.id }} .product-list'
            });

            $('#{{ form.customer.vars.id }}').trigger('select2:select');
        });
    </script>
{% endblock %}

{% block summary_template %}
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
    <xsl:output method="xml"/>
    <xsl:template match="transaction">
        <div class='card-box'>
        <div class='card-box'>
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Status"|trans({},"TransactionBundle") }}</b>
                </div>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <span class="label label-success">Submited</span>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Transaction Number"|trans({},"TransactionBundle") }}</b>
                </div>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <span><xsl:value-of select="number"/></span>
                </div>
            </div>
        </div>
        <div class='card-box'>
            <h4 class="header-title m-t-0">{{ "Products"|trans({}, "TransactionBundle") }}</h4>
            <hr />
            <xsl:choose>
                <xsl:when test='not ((status = 2) or (status = 3))'>
                <div class='row'>
                    <div class='col-sm-4 col-xs-4'><b>{{ "Product"|trans({}, "TransactionBundle") }}</b></div>
                    <div class='col-sm-4 col-xs-4'><b>{{ "Current"|trans({}, "TransactionBundle") }}</b></div>
                    <div class='col-sm-4 col-xs-4'><b>{{ "After"|trans({}, "TransactionBundle") }}</b></div>
                </div>
                <xsl:for-each select="subtransactions/i">
                    <div class='row subtransaction'>
                        <xsl:attribute name='data-index'>
                            <xsl:value-of select='index' />
                        </xsl:attribute>
                        <xsl:choose>
                            <xsl:when test="customerproduct/immutablecustomerproductdata">
                                <div class='col-sm-4 col-xs-4'><span><xsl:value-of select="customerproduct/product/name"/></span> (<span><xsl:value-of select="customerproduct/immutablecustomerproductdata"/></span>)</div>
                            </xsl:when>
                            <xsl:otherwise>
                                <div class='col-sm-4 col-xs-4'><span><xsl:value-of select="customerproduct/product/name"/></span> (<span><xsl:value-of select="customerproduct/username"/></span>)</div>
                            </xsl:otherwise>
                        </xsl:choose>
                        <div class='col-sm-4 col-xs-4'><span><xsl:value-of select="customerproduct/balance"/></span></div>
                        <div class='col-sm-4 col-xs-4'><span><xsl:value-of select="afterbalance"/></span></div>
                    </div>
                </xsl:for-each>
                </xsl:when>
                <xsl:otherwise>
                <div class='row'>
                    <div class='col-sm-4 col-xs-4'><b>{{ "Product"|trans({}, "TransactionBundle") }}</b></div>
                    <div class='col-sm-8 col-xs-8'><b>{{ "Balance"|trans({}, "TransactionBundle") }}</b></div>
                </div>
                <xsl:for-each select="subtransactions/i">
                    <div class='row subtransaction'>
                        <xsl:attribute name='data-index'>
                            <xsl:value-of select='index' />
                        </xsl:attribute>
                        <xsl:choose>
                            <xsl:when test="customerproduct/immutablecustomerproductdata">
                                <div class='col-sm-4 col-xs-4'><span><xsl:value-of select="customerproduct/product/name"/></span> (<span><xsl:value-of select="customerproduct/immutablecustomerproductdata"/></span>)</div>
                            </xsl:when>
                            <xsl:otherwise>
                                <div class='col-sm-4 col-xs-4'><span><xsl:value-of select="customerproduct/product/name"/></span> (<span><xsl:value-of select="customerproduct/username"/></span>)</div>
                            </xsl:otherwise>
                        </xsl:choose>
                        <div class='col-sm-8 col-xs-8'><span><xsl:value-of select="customerproduct/balance"/></span></div>
                    </div>
                </xsl:for-each>
                </xsl:otherwise>
            </xsl:choose>
        </div>

        <div class='card-box'>
            {% for subtransaction in transaction.subTransactions %}
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Win/Loss"|trans({},"TransactionBundle") }}</b>
                </div>

                <div class='col-md-6 col-sm-6 col-xs-6'>
                    {% if subtransaction.details.dwl.brokerage is defined %}
                        <span>{{ subtransaction.details.dwl.brokerage.winLoss|number_format(2, '.', '') }}</span>
                    {% else %}
                        <span>{{ subtransaction.amount|number_format(2, '.', '') }}</span>
                    {% endif %}
                </div>
            </div>
            {% if subtransaction.details.dwl.brokerage is defined and subtransaction.details.dwl.brokerage is not null %}
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Returned"|trans({},"TransactionBundle") }}</b>
                </div>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <span>{{ subtransaction.getDwlReturn()|number_format(2, '.', '') }}</span>
                </div>
            </div>
            {% endif %}
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Turnover"|trans({},"TransactionBundle") }}</b>
                </div>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <span>{{ subtransaction.details.dwl.turnover|number_format(2, '.', '') }}</span>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Gross Commission"|trans({},"TransactionBundle") }}</b>
                </div>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <span>{{ subtransaction.details.dwl.gross|number_format(2, '.', '') }}</span>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <b>{{ "Member Commission"|trans({},"TransactionBundle") }}</b>
                </div>
                <div class='col-md-6 col-sm-6 col-xs-6'>
                    <span>{{ subtransaction.details.dwl.commission|number_format(2, '.', '') }}</span>
                </div>
            </div>
            {% endfor  %}
        </div>
        </div>
    </xsl:template>

</xsl:stylesheet>
{% endblock summary_template %}