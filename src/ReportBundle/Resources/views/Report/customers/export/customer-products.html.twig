{% extends 'AppBundle:Layout:base.html.twig' %}

{% block title %}Reports | Member Products {% endblock %}

{% block stylesheets %}
    <style>
        #checked {
            font-size: 30px;
            font-weight: bold;
            color: #22AC38;
            width: 100%;
            position: absolute;
        }
        #checked i {
            margin-top: 60px;
        }
        .widget-chart {
            position: relative;
        }
    </style>
{% endblock stylesheets %}

{% block body %}
    <div class="wrapper">
        <div class="topbar">
            <!-- LOGO -->
            <div class="topbar-left">
                <div class="text-center">
                    <!--a href="{{ path('app.dashboard_page') }}" class="logo"><i class="icon-magnet icon-c-logo"></i><span>Superm<i class="md md-album"></i><i class="md md-album"></i>n</span></a-->
                    <!-- Image Logo here -->
                    <a href="{{ path('app.dashboard_page') }}" class="logo">
                        <i class="icon-c-logo"><img src="{{ asset("assets/images/favicon_img.png") }}" height="20"/> </i>
                        <span><img src="{{ asset("assets/images/acc66_logo.png") }}" height="42"/></span>
                    </a>
                </div>
            </div>
            <!-- Button mobile view to collapse sidebar menu -->
            <div class="navbar navbar-default" role="navigation">
                <div class="container">
                    <div class="">
                    </div>
                </div>
            </div>
        </div>
        <div class="content-page" style="margin-left: 0px">
            <!-- Start content -->
            <div class="content">
                <div class="container">
                    <div class="row">
                        <div class="card-box col-md-4 col-md-offset-4 m-t-40">
                            <h4 class="text-dark  header-title m-t-0 m-b-30">Downloading: Member Products</h4>
                            <div class="widget-chart text-center">
                                <div id="checked" class="hide">
                                    <i class='fa fa-check'></i>
                                </div>
                                <input class="knob" data-width="150" data-height="150" data-fgColor="#FF0000" value="0" data-angleOffset="180" data-readOnly=true data-thickness=".50"/>
                                <h5 class="text-muted m-t-20">
                                    File: {{ filename }}_{{ filters.from|date('Ymd') }}_{{ filters.to|date('Ymd') }}.csv
                                </h5>
                                <ul class="list-inline m-t-15">
                                    {% if product is not null %}
                                    <li>
                                        <h5 class="text-muted m-t-20">Product</h5>
                                        <h4 class="m-b-0">{{ product.name }}</h4>
                                    </li>
                                    {% endif %}
                                    {% if currency is not null %}
                                    <li>
                                        <h5 class="text-muted m-t-20">Currency</h5>
                                        <h4 class="m-b-0">{{ currency.code }}</h4>
                                    </li>
                                    {% endif %}
                                    {% if customer is not null %}
                                    <li>
                                        <h5 class="text-muted m-t-20">Member</h5>
                                        <h4 class="m-b-0">{{ customer.fName }} {{ customer.lName }} ({{ customer.user.username }})</h4>
                                    </li>
                                    {% endif %}
                                    <li>
                                        <h5 class="text-muted m-t-20">From</h5>
                                        <h4 class="m-b-0">{{ filters.from|date('M d, Y') }}</h4>
                                    </li>
                                    <li>
                                        <h5 class="text-muted m-t-20">To</h5>
                                        <h4 class="m-b-0">{{ filters.to|date('M d, Y') }}</h4>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <a id="download" href="" class="hide" target="__blank" download="{{ filename }}_{{ filters.from|date('Ymd') }}_{{ filters.to|date('Ymd') }}.csv">Download</a>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}

{% block javascripts %}
    <script src="{{ asset("assets/plugins/jquery-knob/jquery.knob.js") }}"></script>
    <script type="text/javascript">
        var records = [];
        var summary = {
            'cproduct_username': 'Total',
            'turnover': 0,
            'gross': 0,
            'win_loss': 0,
            'commission': 0,
            'current_balance': 0,
            'after': {
                'total': 0
            }
        };
        function getRecords(page) {
            $.ajax({
                'url': '{{ path('report.customer_products') }}',
                'data': {
                    'filters':{{ filters|json_encode()|raw('js') }},
                    'length': 200,
                    'limit': 200,
                    'page': page,
                    'export': true
                },

                'success': function (data) {
                    totalPage = data.recordsFiltered / data.limit;
                    if (data.records.length > 0) {
                        for (var i in data.records) {
                            var record = data.records[i];
                            records.push(record);
                            summary.turnover = Decimal.add(summary.turnover, record.turnover).toString();
                            summary.gross = Decimal.add(summary.gross, record.gross).toString();
                            summary.win_loss = Decimal.add(summary.win_loss, record.win_loss).toString();
                            summary.commission = Decimal.add(summary.commission, record.commission).toString();
                            summary.current_balance = Decimal.add(summary.current_balance, record.current_balance).toString();
                            summary.after.total = Decimal.add(summary.after.total, record.after.total).toString();
                        }
                    }
                    var percentage =  Math.floor((records.length / data.recordsTotal) * 100);

                    if (percentage <= 20) {
                        $(".knob").trigger('configure', {
                            "fgColor":"#FF0000",
                            'inputColor': '#FF0000'
                        });
                    } else if (percentage <= 40) {
                        $(".knob").trigger('configure', {
                            "fgColor":"#F39800",
                            'inputColor': '#F39800'
                        });
                    } else if (percentage <= 60) {
                        $(".knob").trigger('configure', {
                            "fgColor":"#FFF100",
                            'inputColor': '#FFF100'
                        });
                    } else if (percentage <= 80) {
                        $(".knob").trigger('configure', {
                            "fgColor":"#CFDB00",
                            'inputColor': '#CFDB00'
                        });
                    } else if (percentage <= 99) {
                        $(".knob").trigger('configure', {
                            "fgColor":"#8FC31F",
                            'inputColor': '#8FC31F'
                        });
                    } else {
                        $(".knob").trigger('configure', {
                            "fgColor":"#22AC38",
                            'inputColor': '#22AC38',
                            'displayInput': false
                        });
                        $('#checked').removeClass('hide');
                    }

                    $('.knob').val(percentage).trigger('change');

                    // totalPage = 2;
                    if (data.page < totalPage) {
                        getRecords(data.page + 1);
                    } else {
                        var dataToDownload = '';
                        {% if product is not null %}
                            dataToDownload += "Product:,{{ product.name }}\n";
                        {% endif %}
                        {% if currency is not null %}
                            dataToDownload += "Currency:,{{ currency.code }}\n";
                        {% endif %}
                        {% if customer is not null %}
                            dataToDownload += "Customer:,{{ customer.fName }} {{ customer.lName }}\n"
                                + "Username:,{{ customer.user.username }}\n";
                        {% endif %}
                        dataToDownload += 'From:,"{{ filters.from|date("M d, Y") }}"';
                        dataToDownload += '\nTo:,"{{ filters.to|date("M d, Y") }}"';
                        dataToDownload += '\n\nCustomer Product,Turover,Gross Commission,Win/Loss,Commission,"Balance: {{ filters.to|date("M d, Y") }}",Current Balance';
                        for (var i in records) {
                            var record = records[i];
                            dataToDownload += "\n" + generateData(record);
                        }

                        dataToDownload += "\n\n" + generateData(summary);

                        var csvData = 'data:application/csv;content-disposition=;charset=utf-8,' + encodeURIComponent(dataToDownload);
                        $('#download').attr('href', csvData);
                        $('#download').get(0).click();
                    }
                }
            });
        }

        function generateData(record) {
            var flattenRecord = [
                '"' + record.cproduct_username + '"',
                record.turnover,
                record.gross,
                record.win_loss,
                record.commission,
                Decimal.sub(record.current_balance, record.after.total).toFixed(2),
                record.current_balance
            ];

            return flattenRecord.join(',');
        }

        $(function () {
            $(".knob").knob();
            getRecords(1);
        });
    </script>
{% endblock javascripts %}