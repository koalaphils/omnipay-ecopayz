{% use "AppBundle:Widget:base.html.twig"  %}

{% block widget_container %}
    <div class="{{ block_id }}">
    {{ widget_render_block(widget, 'widget') }}
    </div>

    {{ widget_render(widget.getChild('commission_form')) }}
{% endblock widget_container %}

{% block affiliateCommissionList_widget %}
    {% if widget.canAdd() %}
    <div class="pull-right">
        <button id="{{ id }}_add" class="btn btn-sm btn-primary">Add Commission</button>
    </div>
    {% endif %}
    <div id="{{ block_id }}">
        <table id="{{ id }}_table" class="table table-bordered table-striped dt-responsive nowrap" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Currency</th>
                    <th>% Commission</th>
                    <th>Date Last Updated</th>
                    <th>No. of Customers</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
        </table>
    </div>
{% endblock affiliateCommissionList_widget %}

{% block affiliateCommissionList_assetjs %}
{{ asset_render('js', 'default', [asset('bundles/app/js/ZTable.js')]) }}
{% endblock affiliateCommissionList_assetjs %}

{% block affiliateCommissionList_stylesheet %}
    <style type="text/css">
        .{{ id }}_loading {
            width: 100%;
            text-align: center;
            padding: 25px;
        }
    </style>
{% endblock affiliateCommissionList_stylesheet %}

{% block affiliateCommissionList_javascript %}
    <script type="text/javascript">
        var customerList = null;
        $(function () {
            customerList = new ZTable(
                '#{{ id }}_widget',
                {
                    'dom': 't',
                    'ajax': {
                        'headers': {
                            'X-WIDGET-REQUEST': 'onGetCommissions',
                            'X-WIDGET-PATH': '{{ widget_path }}',
                            'X-WIDGET-ID': '{{ id }}'
                        },
                        'dataFilter': function (str) {
                            var draw = this.draw;
                            var json = $.parseJSON( str );
                            var data = json.records;
                            for (var i in data) {
                                data[i]['counts'] = {
                                    'productId': data[i].product.id,
                                    'currencyId': data[i].currency.id,
                                    'totalCustomers': 0,
                                    'totalCustomerProducts': 0
                                };
                                if (typeof json.counts[data[i].product.id + '_' + data[i].currency.id] != 'undefined') {
                                    data[i]['counts'] = json.counts[data[i].product.id + '_' + data[i].currency.id];
                                }
                            }

                            return JSON.stringify({
                                'draw': draw,
                                'data': data,
                                'recordsFiltered': json.recordsFiltered,
                                'recordsTotal': json.recordsTotal
                            });
                        }
                    },
                    'columns': [
                        {'data': 'product.name'},
                        {'data': 'currency.code'},
                        {
                            'data': 'commission',
                            'render': function (data) {
                                return data + '%';
                            }
                        },
                        {
                            'data': 'created_at',
                            'render': function (data) {
                                return moment(data).format('MMM D, YYYY h:mm A');
                            }
                        },
                        {'data': 'counts.totalCustomers'},
                        {
                            'data': 'status',
                            'render': function (data) {
                                if (data === {{ constant('DbBundle\\Entity\\AffiliateCommission::COMMISSION_STATUS_ACTIVE') }}) {
                                    return 'Active';
                                } else {
                                    return 'Suspended';
                                }
                            }
                        },
                        {
                            'render': function (data, text, full) {
                                var editBtn = '<button class="btn btn-xs btn-edit btn-primary m-r-5" data-commisison="' + full.id + '">Edit</button>';
                                var suspendBtn = '<button class="btn btn-xs btn-suspend btn-danger">Suspend</button>';
                                var activateBtn = '<button class="btn btn-xs btn-activate btn-success">Activate</button>';
                                var btn = editBtn;
                                if (full.status === {{ constant('DbBundle\\Entity\\AffiliateCommission::COMMISSION_STATUS_ACTIVE') }}) {
                                    btn += suspendBtn;
                                } else {
                                    btn += activateBtn;
                                }

                                return btn;
                            }
                        }
                    ]
                }
            );

            $('#{{ id }}_add').click(function () {
                $('#{{ widget.getChild('commission_form').getFullId() }}_container .modal-content').html('<div class="{{ id }}_loading"><i class="fa fa-4x fa-circle-o-notch fa-spin"></li></div>');
                $('#{{ widget.getChild('commission_form').getFullId() }}_container').modal('show');
                $.ajax({
                    'headers': {
                        'X-WIDGET-REQUEST': 'onRenderFormView',
                        'X-WIDGET-PATH': '{{ widget_path }}',
                        'X-WIDGET-ID': '{{ id }}',
                    },
                    'dataType': 'script'
                });
            });

            $('#{{ id }}_table').on('click', '.btn-edit', function () {
                var commissionId = $(this).data('commission');
                var commissionData = customerList.dataTable.api().row($(this).closest('tr')).data();
                $('#{{ widget.getChild('commission_form').getFullId() }}_container .modal-content').html('<div class="{{ id }}_loading"><i class="fa fa-4x fa-circle-o-notch fa-spin"></li></div>');
                $('#{{ widget.getChild('commission_form').getFullId() }}_container').modal('show');
                $.ajax({
                    'headers': {
                        'X-WIDGET-REQUEST': 'onRenderFormView',
                        'X-WIDGET-PATH': '{{ widget_path }}',
                        'X-WIDGET-ID': '{{ id }}',
                    },
                    'dataType': 'script',
                    'type': 'POST',
                    'data': {'commission': commissionData.id}
                });
            });

            $('#{{ id }}_table').on('click', '.btn-suspend', function () {
                var commissionId = $(this).data('commission');
                var commissionData = customerList.dataTable.api().row($(this).closest('tr')).data();
                window.confirm2(
                    'Do you realy want to suspend ' + commissionData.product.name + '-' + commissionData.currency.code,
                    'Suspend',
                    {},
                    function (confirmed) {
                        if (confirmed) {
                            $.ajax({
                                'headers': {
                                    'X-WIDGET-REQUEST': 'onSuspendCommission',
                                    'X-WIDGET-PATH': '{{ widget_path }}',
                                    'X-WIDGET-ID': '{{ id }}',
                                },
                                'type': 'POST',
                                'data': {'commission': commissionData.id},
                                'success': function (response) {
                                    window.alert2(
                                        'Successfully suspended ' + response.data.product.name + '-' + response.data.currency.code,
                                        'Suspended',
                                        {'type': 'success'}
                                    );
                                    customerList.reloadTable();
                                }
                            });
                        }
                    }
                );
            });

            $('#{{ id }}_table').on('click', '.btn-activate', function () {
                var commissionId = $(this).data('commission');
                var commissionData = customerList.dataTable.api().row($(this).closest('tr')).data();
                window.confirm2(
                    'Do you realy want to activate ' + commissionData.product.name + '-' + commissionData.currency.code,
                    'Activate',
                    {},
                    function (confirmed) {
                        if (confirmed) {
                            $.ajax({
                                'headers': {
                                    'X-WIDGET-REQUEST': 'onActivateCommission',
                                    'X-WIDGET-PATH': '{{ widget_path }}',
                                    'X-WIDGET-ID': '{{ id }}',
                                },
                                'type': 'POST',
                                'data': {'commission': commissionData.id},
                                'success': function (response) {
                                    window.alert2(
                                        'Successfully activated ' + response.data.product.name + '-' + response.data.currency.code,
                                        'Activated',
                                        {'type': 'success'}
                                    );
                                    customerList.reloadTable();
                                }
                            });
                        }
                    }
                );
            });
        })
    </script>
{% endblock affiliateCommissionList_javascript %}

{% block affiliateCommissionForm_container %}
    <div id="{{ block_id }}" class="modal fade" aria-hidden="true">
        {{ widget_render_block(widget, 'widget') }}
    </div>
{% endblock affiliateCommissionForm_container %}

{% block affiliateCommissionForm_widget %}
    <div class='modal-dialog modal-responsive'>
        <div class='modal-content p-0 b-0'></div>
    </div>
{% endblock affiliateCommissionForm_widget %}

{% block affiliateCommissionForm_form_view -%}
    {% form_theme form _self %}
    {% spaceless %}
        <div class='panel panel-color panel-inverse'>
            <div class="panel-heading">
                {% if widget.isCreate() -%}
                <h3 class="panel-title">Add Commission</h3>
                {% else %}
                    <h3 class="panel-title">Update Commission</h3>
                {%- endif %}
            </div>
            <div class='panel-body p-20'>
                {{ form_start(form) }}
                {% if widget.isCreate() %}
                {{ form_row(form.product) }}
                {% else %}
                    <div class='col-sm-12'>
                        <div class='form-group'>
                            <label>Product</label>
                            <span class='form-control'>{{ commission.product.name }}</span>
                        </div>
                    </div>
                {% endif %}
                {{ form_row(form.commission) }}
                {{ form_row(form.status) }}
                {{ form_end(form) }}
            </div>
            <div class='panel-footer text-right'>
                {% if widget.isCreate() -%}
                    <button class='btn btn-sm btn-success m-r-5 btn-add btn-save'>Add</button>
                {%- else -%}
                    <button class='btn btn-sm btn-success m-r-5 btn-update btn-save'>Update</button>
                {%- endif %}
                <button class='btn btn-sm btn-inverse' data-dismiss='modal'>Cancel</button>
            </div>
        </div>
    {% endspaceless %}
{%- endblock affiliateCommissionForm_form_view %}

{% block _affiliateCommissionList_commission_form_form_product_widget %}
    {% spaceless %}
        {%- set attr = attr|merge({class: (attr.class|default('') ~ ' form-control')|trim}) -%}
        {%- set required = false -%}
        <select {{ block('widget_attributes') }} >
        </select>
    {% endspaceless %}
{% endblock _affiliateCommissionList_commission_form_form_product_widget  %}

{% block _affiliateCommissionList_commission_form_form_commission_widget %}
    {% spaceless %}
        <div class="input-group">
            {{ form_widget(form) }}
            <span class="input-group-addon">%</span>
        </div>
    {% endspaceless %}
{% endblock _affiliateCommissionList_commission_form_form_commission_widget %}

{% block affiliateCommissionForm_form %}
    {% spaceless %}
    function isScriptExists(url) {
        var scripts = document.getElementsByTagName('script');
        for (var i = 0; i < scripts.length; i++) {
            if (scripts[i].src == url) {
                return true;
            }
        }

        return false;
    }

    if (!isScriptExists('{{ absolute_url(asset('assets/plugins/jquery-form/jquery.form.min.js')) }}')) {
        var body = document.getElementsByTagName('body')[0];
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = '{{ absolute_url(asset('assets/plugins/jquery-form/jquery.form.min.js')) }}';
        script.onload = function () {
            execPage();
        };
        body.appendChild(script);
    } else {
        execPage();
    }

    function execPage() {
        var form = '{{- block('affiliateCommissionForm_form_view')|escape('html')|raw -}}';
        $('#{{ id }}_container .modal-content').html($('<div></div>').html(form).text());
        $('#{{ form.status.vars.id }}').each(function () {
            new Switchery(this);
        });
        {% if widget.isCreate() %}
        $('#{{ form.product.vars.id }}').select2({
            'ajax': {
                'dataType': 'json',
                'headers': {
                    'X-WIDGET-REQUEST': 'onAvailableProducts',
                    'X-WIDGET-PATH': '{{ widget_path }}',
                    'X-WIDGET-ID': '{{ id }}'
                },
            },
            'templateResult': function(data) {
                if(data.id === null || data.id === '' || !data.id) {
                    return data.text;
                }

                return data.name;
            },
            'templateSelection': function(data, container) {
                if(data.id === null || data.id === '' || !data.id) {
                    return data.text;
                }

                return data.name;
            }
        });
        {% endif %}

        $('#{{ id }}_container .btn-save').click(function () {
            $('#{{ form.vars.id }}').submit();
        });

        $('#{{ form.vars.id }}').ajaxForm({
            'headers': {
                'X-WIDGET-REQUEST': '{{ widget.isCreate() ? "onAddCommission" : "onUpdateCommission"  }}',
                'X-WIDGET-PATH': '{{ widget_path }}',
                'X-WIDGET-ID': '{{ id }}'
                {% if not widget.isCreate() %},'X-SET-PROPERTIES': '{ "commission" : {{ widget.property('commission') }} }'{% endif %}
            },
            'success': function (data) {
                $('#{{ id }}_container').modal('hide');
                customerList.reloadTable();
            }
        });
    }
    {% endspaceless %}
{% endblock affiliateCommissionForm_form %}