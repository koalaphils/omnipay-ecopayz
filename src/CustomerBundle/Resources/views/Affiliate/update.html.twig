{% extends 'AppBundle:Layout:base.html.twig' %}

{% form_theme customerProductForm _self %}
{% form_theme securityForm _self %}
{% form_theme contactForm 'CustomerBundle:Form:Type/contact.html.twig' %}
{% form_theme socialForm 'CustomerBundle:Form:Type/social.html.twig' %}
{% form_theme paymentForm 'CustomerBundle:Form:Type/payment.html.twig' %}
{% form_theme form 'CustomerBundle:Form:Type/customer.html.twig' %}

{% form_theme form 'CustomerBundle:Customer:FormTheme/customer.html.twig' %}

{% block title %}{{ "page.title.update_affiliate"|trans({'%fullName%':customer.fName ~ ' ' ~ customer.lname},"CustomerBundle") }}{% endblock %}

{% block form_label_class %}{% endblock %}

{% block form_group_class %}
{% endblock %}

{%- block form_start -%}
    {% set method = method|upper %}
    {%- if method in ["GET", "POST"] -%}
        {% set form_method = method %}
    {%- else -%}
        {% set form_method = "POST" %}
    {%- endif -%}
    <form name="{{ name }}" class="form-danger" method="{{ form_method|lower }}"{% if action != '' %} id="{{ id }}" action="{{ action }}"{% endif %}{% for attrname, attrvalue in attr %} {{ attrname }}="{{ attrvalue }}"{% endfor %}{% if multipart %} enctype="multipart/form-data"{% endif %}>
    {%- if form_method != method -%}
        <input type="hidden" name="_method" value="{{ method }}" />
    {%- endif -%}
{%- endblock form_start -%}

{% block stylesheet_plugins %}
    <link href="{{ asset('assets/plugins/select2/css/select2.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset("assets/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css") }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset("assets/plugins/bootstrap-select/css/bootstrap-select.min.css") }}" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet" type="text/css" href="{{ asset("assets/plugins/dropzone/dropzone.css") }}" />
    <link rel='stylesheet' type="text/css" href="{{ asset("assets/plugins/x-editable/css/bootstrap-editable.css") }}" />
    <link href="{{ asset('assets/plugins/datatables/jquery.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.colVis.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('assets/plugins/datatables/dataTables.bootstrap.min.css') }}" rel="stylesheet" type="text/css"/>
    {{ form_assetcss(form) }}
    {{ form_assetcss(customerProductForm) }}
    {{ form_assetcss(securityForm) }}
    {{ form_assetcss(paymentForm) }}
{% endblock %}

{% block javascript_plugins %}
    <script src="{{ asset('bundles/app/js/ZTable.js') }}"></script>
    <script src="{{ asset('assets/plugins/select2/js/select2.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/bootstrap-select/js/bootstrap-select.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/bootstrap-select/js/bootstrap-select-ajax.js') }}"></script>
    <script src="{{ asset("assets/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js") }}"></script>

    <script type="text/javascript" src="{{ asset("assets/plugins/dropzone/dropzone.js") }}"></script>
    <script src="{{ asset('assets/plugins/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.bootstrap.js') }}"></script>

    <script src="{{ asset('assets/plugins/datatables/dataTables.buttons.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/buttons.bootstrap.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/vfs_fonts.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/buttons.html5.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/responsive.bootstrap.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/datatables/dataTables.colVis.js') }}"></script>
    <script src="{{ asset('assets/plugins/x-editable/js/bootstrap-editable.min.js') }}"></script>
    <script src="{{ asset('assets/plugins/areYouSure/areYouSure.js') }}"></script>
    {{ form_assetjs(form) }}
    {{ form_assetjs(customerProductForm) }}
    {{ form_assetjs(securityForm) }}
    {{ form_assetjs(paymentForm) }}
    <script type="text/javascript" >
        $(function(){
            var activeTab = '{{activeTab}}';
            var formName;

            $('form').each(function(){
                if(!$(this).parent().hasClass('modal-content')){
                    $(this).areYouSure({'silent':true});
                }
            });

            $('form :input').on('change input', function() {
                formName = $(this).closest('form').attr('id');
            });

            $('.tabs-vertical-env a[href="#' +  activeTab + '"]').tab('show');
            $('.customer-tab').click(function(e){
                e.preventDefault();
                var customerTab = $(this).attr('href');
                if ( $('form[id = "'+ formName  + '" ]').hasClass('dirty') ){
                    e.stopPropagation();
                    location.href.split('#')[0];
                    swal({
                        title: "Unsaved data will be lost",
                        text: "Are you sure you want to discard changes?",
                        type: "warning",
                        confirmButtonClass : 'btn-success btn-md',
                        confirmButtonText : 'OK',
                        cancelButtonClass: 'btn-inverse btn-md',
                        cancelButtonText: 'Cancel',
                        showCancelButton: true,
                        closeOnConfirm: false
                    },
                    function(isProceed) {
                        if (isProceed) {
                            history.pushState({}, null, customerTab.replace("#",''));
                            $('.tabs-vertical-env a[href="' +  customerTab + '"]').tab('show');
                            location.reload();
                        }
                    });
                }else{
                    history.pushState({}, null, customerTab.replace("#",''));
                }
            });

            $('.content-page a , #sidebar-menu a ').click(function(e){

                var link = $(this).attr('href');
                if(link == "javascript:void(0)"){
                    e.preventDefault();
                }else{
                    if (!$(this).hasClass('customer-tab')){
                        e.preventDefault();
                        if ( $('form[id = "'+ formName  + '" ]').hasClass('dirty') ){
                                swal({
                                title: "Unsaved data will be lost",
                                text: "Are you sure you want to discard changes and leave the page?",
                                type: "warning",
                                confirmButtonClass : 'btn-success btn-md',
                                confirmButtonText : 'Leave',
                                cancelButtonClass: 'btn-inverse btn-md',
                                cancelButtonText: 'Stay',
                                showCancelButton: true,
                                closeOnConfirm: false
                            },
                            function(isProceed) {
                                if (isProceed) {
                                    window.location = link;
                                }
                            });
                        }else{
                            window.location = link;
                        }
                    }
                }
            });
        });

    </script>
{% endblock %}

{% block stylesheets -%}
    <link rel="stylesheet" type="text/css" href="{{ asset('bundles/customer/css/document.css') }}" />
    <style rel="stylesheet">
        .payment-list {
            margin-top: 10px;
        }

        .payment-list .payment-item {
            max-height: 115px;
            height: 115px;
        }

        .payment-list .payment-item:hover {
            background: #a9f4ff;
            cursor: pointer;
        }

        .payment-list .payment-img-col {
            display: table-cell;
            float: none;
            text-align: center;
            vertical-align: middle;
        }

        .payment-list .payment-info {
            display: table-cell;
            float: none;
        }

        .payment-img img {
            max-width: 98%;
            max-height: 98%;
        }

        .payment-list .selected .payment-item {
            background: #4ea5e0;
            border-color: #2581b8;
            color: #ecf0f1;
        }
    </style>
{%- endblock %}

{% block pageTitle -%}{{ "page.Update Affiliate"|trans({},"CustomerBundle") }}{%- endblock %}

{% block breadcrumb -%}
    <li>{{ "breadcrumb.marketing"|trans({},"AppBundle") }}</li>
    <li>
        <a href="{{ path("affiliate.list_page") }}">{{ "breadcrumb.list"|trans({},"CustomerBundle") }}</a>
    </li>
    <li class="active">
        {{ customer.user.username }}
    </li>
{%- endblock  %}

{% block pageHeaderExtra %}
<div class="pull-right">
    {% if is_granted('ROLE_CUSTOMER_VIEW') %}
    <a class="btn btn-inverse waves-effect waves-light pull-right m-b-10" href="{{ path("affiliate.list_page") }}"><span><i class="ti-arrow-left m-r-5 cls-icn-plus"></i></span> {{ "menus.BackToAffiliate"|trans({},"CustomerBundle") }}</a>
    {% endif %}
    <ul class="list-inline quicklinks font-13 font-normal text-right">
        <li>{{ "quickLinks.name"|trans({},"CustomerBundle") }}:</li>
        {% if is_granted('ROLE_CUSTOMER_CREATE') %} 
        <li><a href="{{ path("affiliate.create_page") }}">{{ "quickLinks.addAffiliate"|trans({},"CustomerBundle") }}</a></li>|
        {% endif %}
        {% if is_granted('ROLE_CUSTOMER_VIEW') %}
        <li><a href="{{ path("customer.list_page") }}">{{ "quickLinks.customerList"|trans({},"CustomerBundle") }}</a></li>|
        {% endif %}
        {% if is_granted('ROLE_CUSTOMER_CREATE') %}
        <li><a href="{{ path("customer.create_page") }}">{{ "quickLinks.addCustomer"|trans({},"CustomerBundle") }}</a></li>
        {% endif %}
    </ul>
</div>
{% endblock pageHeaderExtra %}

{% block page %}
    <div class="col-sm-12">
        <div class="tabs-vertical-env">
            {% include "CustomerBundle:Affiliate:tabs.html.twig" %}
            <div class="tab-content" style="width : 100%">
                {% if app.request.attributes.get('_route') in ['customer.update_page','affiliate.update_page'] %}
                <div class="tab-pane active" id="profile">
                    {% include "CustomerBundle:Form:customer-form.html.twig" %}
                </div>
                <div class="tab-pane" id="product">
                    {% include "CustomerBundle:Default:Tabs/products.html.twig" %}
                </div>
                {% if guestType == 'Customer'  %}
                <div class="tab-pane" id="security">
                    {% include "CustomerBundle:Form:customerSecurity-form.html.twig" %}
                </div>
                {%- endif -%}
                <div class="tab-pane" id="contacts">
                    {% include "CustomerBundle:Form:customerContacts-form.html.twig" %}
                </div>
                <div class="tab-pane" id="socials">
                    {% include "CustomerBundle:Form:customerSocials-form.html.twig" %}
                </div>
                <div class="tab-pane" id="payments">
                    {% include "CustomerBundle:Default:Tabs/payments.html.twig" %}
                </div>
                <div class="tab-pane" id="docs">
                    {% include "CustomerBundle:Form:customerDocuments-form.html.twig" %}
                </div>
                <div class="tab-pane" id="transactions">
                    {% include "CustomerBundle:Default:Tabs/transactions.html.twig" %}
                </div>
                <div class="tab-pane" id="customers">
                    <div id="customerList" class="card-box">
                        <table id="customerTab"
                            class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0"
                            width="100%">
                            <thead>
                                <tr>
                                    <th>{{ "fields.id"|trans({}, "CustomerBundle") }}</th>
                                    <th>{{ "fields.fullName"|trans({}, "CustomerBundle") }}</th>
                                    <th>{{ "fields.username"|trans({}, "UserBundle") }}</th>
                                    <th>{{ "fields.email"|trans({}, "CustomerBundle") }}</th>
                                    <th>{{ "fields.action"|trans({}, "AppBundle") }}</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('bundles/customer/js/product.js') }}" type="text/javascript" ></script>
    <script src="{{ asset('bundles/customer/js/document.js') }}" type="text/javascript" ></script>
    <script src="{{ asset('bundles/customer/js/payments.js') }}" type="text/javascript" ></script>
    <script src="{{ asset('bundles/customer/js/list.js') }}" type="text/javascript" ></script>
    {{ form_javascript(form) }}
    {{ form_javascript(customerProductForm) }}
    {{ form_javascript(contactForm) }}
    {{ form_javascript(socialForm) }}
    {{ form_javascript(paymentForm) }}
    <script type="text/javascript">

        var cproductId = '';
        $(function(){
            changeSwitcheryState({{ kyc.verify.vars.id }},{% if not customer.isVerified -%}0{%- else %}1{%- endif %} );

            $('#CustomerKyc').removeClass('dirty');

            if ($('#CustomerKyc_verify').is(':checked')) {
                $('#CustomerKyc_verify').on('change', function() {
                    if ($(this).is(':checked')) {
                        $('#CustomerKyc').removeClass('dirty');
                    }else{
                        $('#CustomerKyc').addClass('dirty');
                    }
                });
            }

            $('#customerProductModal').on('hide.bs.modal', function() {
                cproductId = '';
                $('#{{ customerProductForm.userName.vars.id  }}').val('');
                $("#{{ customerProductForm.product.vars.id  }}").append("<option value='' selected='selected'></option>");
                $('#{{ customerProductForm.balance.vars.id  }}').val('');
                changeSwitcheryState({{ customerProductForm.isActive.vars.id  }}, true);
                $('#{{ customerProductForm.vars.id }}').find('.form-group').removeClass('has-error');
                $('#{{ customerProductForm.vars.id }}').find('.form-group .help-block ul').html('');
                $("#{{ customerProductForm.saveModal.vars.id }}").removeAttr('disabled');
            });
            $('#customerProductModal').on('show.bs.modal', function() {
                if(cproductId == '') {
                    $('#customerProductModal .update').addClass('hide');
                    $('#customerProductModal .new').removeClass('hide');
                } else {
                    $('#customerProductModal .new').addClass('hide');
                    $('#customerProductModal .update').removeClass('hide');
                }
            });

            $('#customerProductList').productList({
                'url': {
                    'list': '{{ path("customerProduct.list_search" , {'id': customer.id})  -}}'
                },
                'rowOnclick': function(e, dataTable) {
                    e.preventDefault();
                    var currentRow = $(e.target).parents('tr');
                    if (currentRow.hasClass('child')) {
                        currentRow = currentRow.prev();
                    }
                    var data = dataTable.row(currentRow).data() ;
                    var anchor = $(e.target).closest('a');
                    var mode = anchor.attr('action');

                    if (mode == 'edit') {
                        openCustomerProduct(data);
                    } else if (mode == 'suspend') {
                        suspendCustomerProduct(data);
                    } else if (mode == 'enable') {
                        activateCustomerProduct(data);
                    }

                }
            });

            function openCustomerProduct(data)
            {
                cproductId = '/' + data.id;
                $('#customerProductModal .update .id').html(data.product.name);
                $('#customerProductModal').modal("show");
                $('#{{ customerProductForm.userName.vars.id  }}').val(data.userName);
                $("#{{ customerProductForm.product.vars.id  }}").append("<option value='" + data.product.id +"' selected='selected'>" + data.product.name +"</option>");
                $('#{{ customerProductForm.balance.vars.id  }}').val((new Decimal(data.balance)).toFixed(2));
                changeSwitcheryState({{ customerProductForm.isActive.vars.id  }}, data.isActive);
            }

            function suspendCustomerProduct(rowData)
            {
                var customerProduct = rowData;
                var postURL = "{{ path('customerProduct.suspend', {'id': 'customerProduct_id' }) -}}";
                confirm2('Are you sure you want to suspend '+ customerProduct.userName + '('+ customerProduct.product.name +')' , 'Suspend Affiliate Product', {
                    'type': null,
                    'confirmButtonClass': 'btn-success btn-md',
                    'confirmButtonText': 'Yes',
                    'html': true,
                    'showLoaderOnConfirm': true
                }, function(isSuspended) {
                    if(isSuspended) {
                        $.ajax({
                            url : postURL.replace("customerProduct_id", customerProduct.id),
                            globalAjaxComplete : false,
                            type: "POST",
                            dataType: "JSON",
                            success : function (data) {
                                var notifications = data.__notifications || [];
                                swal({
                                    'type': notifications.type,
                                    'title': notifications.title,
                                    'text': notifications.message
                                }, function() {
                                    $('#customerProductList').trigger('refresh');
                                });
                            }
                        });
                    }
                });
            }

            function activateCustomerProduct(rowData)
            {
                var customerProduct = rowData;
                var postURL = "{{ path('customerProduct.activate', {'id': 'customerProduct_id' }) -}}";
                confirm2('Are you sure you want to enable '+ customerProduct.userName + '('+ customerProduct.product.name +')' , 'Enable Affiliate Product', {
                    'type': null,
                    'confirmButtonClass': 'btn-success btn-md',
                    'confirmButtonText': 'Yes',
                    'html': true,
                    'showLoaderOnConfirm': true
                }, function(isActivated) {
                    if(isActivated) {
                        $.ajax({
                            url : postURL.replace("customerProduct_id", customerProduct.id),
                            globalAjaxComplete : false,
                            type: "POST",
                            dataType: "JSON",
                            'success': function (data) {
                                var notifications = data.__notifications || [];
                                swal({
                                    'type': notifications.type,
                                    'title': notifications.title,
                                    'text': notifications.message
                                }, function() {
                                    $('#customerProductList').trigger('refresh');
                                });
                            }
                        });
                    }
                });
            }

            function changeSwitcheryState(el,value){
                if($(el).is(':checked') != value){
                    $(el).trigger("click");
                }
            }

            $('#{{ customerProductForm.saveModal.vars.id }}').click(function () {
                $.ajax({
                    url: "{{path('customerProduct.save') }}" + cproductId ,
                    type: "POST",
                    dataType: "JSON",
                    data:  $("form[name={{ customerProductForm.vars.id }}]").serialize(),
                    'beforeSend': function() {
                        $('#{{ customerProductForm.vars.id }}').find('.form-group').removeClass('has-error');
                        $('#{{ customerProductForm.vars.id }}').find('.form-group .help-block ul').html('');
                        $("#{{ customerProductForm.saveModal.vars.id }}").attr('disabled', 'disabled');
                    },
                    'statusCode': {
                        '422': function(jqXHR) {
                            $(this).data('global-ajax-error', false);
                            $.each(jqXHR.responseJSON.errors, function(i, e) {
                                $('#' + i).closest('.form-group').addClass('has-error');
                                $('#' + i).next().find('ul').append('<li><span class="glyphicon glyphicon-exclamation-sign"></span> '+ this +'</li>');
                            });
                        }
                    },
                    success: function(data){
                        if(data.status) {

                            var m = data.message;
                            var t = data.message.text;
                            if (t instanceof Array) {
                                for (i = 0; i < t.length; i++) {
                                    $.Notification.notify(m.type ,'top center', m.title, t[i]);
                                }
                            } else {
                                $('#customerProductList').trigger('refresh');
                                $.Notification.notify(m.type ,'top center', m.title, m.text);
                                cproductId = '/' + data.result;
                                $('#customerProductModal .new').addClass('hide');
                                $('#customerProductModal .update').removeClass('hide');
                                $('#customerProductModal .update .id').html(data.result);
                                $('#customerProductModal').modal("hide");
                            }


                        } else {
                            console.log('Message: ' + JSON.stringify(data.message));
                        }
                    },
                    'complete': function(jqXHR) {
                        $("#{{ customerProductForm.saveModal.vars.id }}").removeAttr('disabled');
                    }
                });

            });
        });
    </script>
    <script type="text/javascript">
        var oldValue = '';
        $(function() {

            $('#{{ kyc.save.vars.id }}').click(function () {
                var _kycSwitch = $('#{{ kyc.verify.vars.id }}');
                var currentValue = (_kycSwitch.is(':checked'))  ? '1' : '0';
                if(oldValue == '') {
                    oldValue = ('{{customer.isVerified}}') ? '1' : '0';
                }
                if (currentValue ==  oldValue) {
                    swal({
                        'type': 'error',
                        'title': 'Error',
                        'text': 'Nothing to save!'
                    }, function() {
                        return false;
                    });
                } else {
                    var actionLabel = (currentValue == 1) ? 'Verify' : 'Unverify';
                    confirm2('Are you sure you want to '+ actionLabel.toLowerCase() +': <b>{{ customer.fName }} {{ customer.lName }} ({{ customer.user.username }})</b>', actionLabel + ' Affiliate', {
                        'type': null,
                        'confirmButtonClass': 'btn-success btn-md',
                        'confirmButtonText': actionLabel,
                        'cancelButtonClass': 'btn-inverse btn-md',
                        'cancelButtonText': 'Cancel',
                        'html': true,
                        'showLoaderOnConfirm': true
                    }, function(isVerify) {
                        if(isVerify) {
                            $.ajax({
                                url: "{{ path('customer.verify', {'id':customer.id}) }}",
                                globalAjaxComplete : false,
                                data: {
                                    "_status": currentValue
                                },
                                'success': function (data) {
                                    var notifications = data.__notifications || [];
                                    $.each(notifications, function(e) {
                                        oldValue = currentValue;
                                        swal({
                                            'type': this.type,
                                            'title': this.title,
                                            'text': this.message
                                        }, function() {
                                            return false;
                                        });
                                    });
                                    $('form[name="CustomerKyc"]').removeClass('dirty');
                                    location.reload();
                                }
                            });
                        }
                    });
                }
            });


        });
    </script>
    <script type="text/javascript">
        var xhr = {'password':null, 'transactionPassword': null};
        $(function() {
            $('#{{ securityForm.vars.id }}').submit(function(e) {
                e.preventDefault();
                var clicked = $(this).find('button[clicked="clicked"]').attr('name');
                if(clicked == '{{ securityForm.savePassword.vars.full_name }}') {
                    var _xhr = 'password';
                } else if(clicked == '{{ securityForm.saveTransactionPassword.vars.full_name }}') {
                    var _xhr = 'transactionPassword';
                } else var _xhr = 'undefined';

                if(xhr[_xhr]) xhr[_xhr].abort();

                xhr[_xhr] = $.ajax({
                    'url': $(this).attr('action'),
                    'type': $(this).attr('method'),
                    'data': $(this).serialize() + "&" + clicked + "=",
                    'beforeSend': function() {
                        if(_xhr == 'password') {
                            $('#{{ securityForm.user.password.first.vars.id }}').closest('.form-group').removeClass('has-error');
                            $('#{{ securityForm.user.password.first.vars.id }}').next().find('ul').html('');
                        } else if(_xhr == 'transactionPassword') {
                            $('#{{ securityForm.transactionPassword.first.vars.id }}').closest('.form-group').removeClass('has-error');
                            $('#{{ securityForm.transactionPassword.first.vars.id }}').next().find('ul').html('');
                        }
                        $('button[name="' + clicked + '"]').attr('disabled', 'disabled');
                    },
                    'statusCode': {
                        '422': function(jqXHR) {
                            $(this).data('global-ajax-error', false);
                            $.each(jqXHR.responseJSON.errors, function(i, e) {
                                $('#' + i).closest('.form-group').addClass('has-error');
                                $('#' + i).next().find('ul').append('<li><span class="glyphicon glyphicon-exclamation-sign"></span> '+ this +'</li>');
                            });
                        }
                    },
                    'complete': function(jqXHR) {
                        $('button[name="' + clicked + '"]').removeAttr('disabled');
                        $('#{{ securityForm.vars.id }} button').removeAttr('clicked');
                        if(jqXHR.responseJSON.action == 'savePassword') {
                            $('#{{ securityForm.user.password.first.vars.id }}').val('');
                            $('#{{ securityForm.user.password.second.vars.id }}').val('');
                        } else if(jqXHR.responseJSON.action == 'saveTransactionPassword') {
                            $('#{{ securityForm.transactionPassword.first.vars.id }}').val('');
                            $('#{{ securityForm.transactionPassword.second.vars.id }}').val('');
                        }
                    }
                });
            });
            $('#{{ securityForm.vars.id }} button[type="submit"]').click(function(e) {
                $('#{{ securityForm.vars.id }} button').removeAttr('clicked');
                $(this).attr('clicked', 'clicked');
            });

            // Verification
            $('#verify').click(function(e) {
                e.preventDefault();
                confirm2('Are you sure you want to verify: <b>{{ customer.fName }} {{ customer.lName }} ({{ customer.user.username }})</b>', 'Verify Customer', {
                    'type': null,
                    'confirmButtonClass': 'btn-success btn-md',
                    'confirmButtonText': 'Verify',
                    'cancelButtonClass': 'btn-inverse btn-md',
                    'cancelButtonText': 'Cancel',
                    'html': true,
                    'showLoaderOnConfirm': true
                }, function(isVerify) {
                    if(isVerify) {
                        $.ajax({
                            'url': "{{ path('customer.verify', {'id':customer.id}) }}",
                            'globalAjaxComplete' : false,
                            'success': function (data) {
                                var notifications = data.__notifications || [];
                                $.each(notifications, function(e) {
                                    swal({
                                        'type': this.type,
                                        'title': this.title,
                                        'text': this.message
                                    }, function() {
                                        window.location = "{{ path('customer.update_page', { "id": customer.id }) }}";
                                    });
                                });
                            }
                        });
                    }
                });
            });
        });

        function download() {
            var file = $('#documentList').mediaLibrary('getSelectedFile');
            var _path = $('<a>', {href: file.fileInfo.route.render })[0];
            var path = _path.pathname;
            if(_path.search.length > 0) path += _path.search + "&title=" + file.fileInfo.title + '.' + file.fileInfo.ext;
            else path += "?title=" + file.fileInfo.title + '.' + file.fileInfo.ext;

            window.open(path,'_blank');
        }

        function deleteFile() {
            var file = $('#documentList').mediaLibrary('getSelectedFile');
            $.ajax({
                'url': "{{ path('customer.document_delete', {"id": customer.id}) }}",
                'type': 'POST',
                'data': {'index': file.index },
                'success': function(data) {
                    $('.document-details-container .document-file-none').removeClass('hide');
                    $('.document-details-container .document-file-selected ').addClass('hide');
                    var file = $('#documentList').mediaLibrary('getFile', data.index);
                    file.destroy();
                }
            });
        }

        var url = {
            document_save: '{{ path('customer.document_save', {'id': customer.id}) }}',
            document_list: '{{ path('customer.document_list', {'id': customer.id}) }}',
            'paymentOption': {
                'templateFile': '{{ asset('assets/templates/payments.xsl') }}',
                'saveNew': "{{path('customer.payment_option_save', {'id': customer.id, 'paymentOptionId': '__index__'}) }}"
            }
        };

        //var paymentOptions = {*{ setting('paymentOptions')|raw }*};
        //var customerPaymentOptions = {*{ (customer.details.paymentOptions|default([]))|json_encode()|raw }*};

        var paymentOptions = {{ paymentOptions|json_encode()|raw }};
        var customerPaymentOptions = {{ customer.paymentOptions|serialize('json')|raw }};
        var paymentOptionsTemplate = "{{ block('paymentOptionTemplates')|escape('js') }}";


        $(function(){
            {%- if not customer.isCustomer -%}
                $('#{{ form.btnGroup.convert.vars.id }}').click(function() {
                    confirm2(
                        'Are you sure you want to convert {{customer.fName}} {{customer.lName}} to a customer account?',
                        'Convert Affiliate',
                        {
                            'type': null,
                            'confirmButtonClass': 'btn-success btn-md',
                            'confirmButtonText': 'Convert',
                            'cancelButtonClass': 'btn-inverse btn-md',
                            'cancelButtonText': 'Cancel',
                            'html': true,
                            'showLoaderOnConfirm': true
                        },
                        function(isConverted) {
                            if(isConverted) {
                                $.ajax({
                                    url : '{{ path('affiliate.convert_to_customer', {'id':customer.id, 'callback': false}) }}',
                                    globalAjaxComplete : false,
                                    type: "GET",
                                    dataType: "JSON",
                                    success : function (data) {
                                        var notifications = data.__notifications || [];
                                        swal({
                                            'type': notifications.type,
                                            'title': notifications.title,
                                            'text': notifications.message
                                        }, function() {
                                            var redirectUrl = '{{path('customer.update_page', {"id": customer.id}) }}' + '/profile';
                                            window.location = redirectUrl;
                                        });
                                    }
                                });
                            }
                        }
                    );
                });
            {%- endif -%}

            $('#customerList').list({
                'url': {
                    'list': '{{- path("customer.list_search") -}}'
                },
                'data': {
                    'affiliate': {{ customer.id }}
                },
                'columns': [
                    {
                        'data': 'customer.id',
                        'defaultContent': '',
                        'render': function(data, type, full) {
                            return "<a href='"+full.routes.update+"'>"+data+"</a>";
                        }
                    },
                    {   'data': 'customer',
                        'defaultContent': '',
                        'render': function(data, type, full) {
                                return full.customer.fName + '&nbsp;' + full.customer.lName;
                        }
                    },
                    { 'data': 'customer.user.username', 'defaultContent': '' },
                    { 'data': 'customer.user.email', 'defaultContent': '' },
                    {
                        'data': 'customer',
                        'render': function(data, text, full) {
                            var action = "<a class='btn btn-icon waves-effect waves-light btn-primary btn-xs btn-icn' href='"+full.routes.update+"/profile'>View</a>";

                            return action;
                        }
                    }
                ]
            });
        });
    </script>
    <script type="text/javascript" src="{{ asset("bundles/customer/js/customer_page.js") }}"></script>
    <script type="text/javascript">
        var userPreferences = {{ app.user.getPreference('ui.customertransaction.list.column.visibility')|json_encode()|raw }};
        $(function(){
            var listTable = new ZTable('#customerTransactionList',  {
                'colvis': {
                    'hidden': function () {
                        var hidden = [];
                        for (var i in userPreferences) {
                            if (userPreferences[i] == 'false') {
                                hidden.push(eval(i));
                            }
                        }

                        return hidden;
                    },
                    'exclude': ['number', 'date']
                },
                'featuresDom': "<'form-inline'"
                    + "<'form-group m-r-10 ft-date'<'m-t-10 xs-date'ft>>"
                    + "poy"
                    + "<'form-group' <'m-t-10'b>>>",
                'ajax': {
                    'url' : '{{ path("transaction.list_search" , {'customerId': customer.id })  -}}'
                },
                'features': {
                    'from': {
                        'dom': "<'form-group form-group-sm m-r-10' <'input-group'i<^span 'input-group-addon bg-white text-default'<!'fa fa-calendar'!>>>>",
                        'type': 'date',
                        'label': 'From',
                        'symbol': 'f',
                        'attrs': {
                            'placeholder': 'From',
                            'type': 'input',
                            'class': 'form-control cls-date'
                        }
                    },
                    'to': {
                        'dom': "<'form-group form-group-sm m-r-10' <'input-group'i<^span 'input-group-addon bg-white text-default'<!'fa fa-calendar'!>>>>",
                        'type': 'date',
                        'label': 'To',
                        'symbol': 't',
                        'attrs': {
                            'placeholder': 'To',
                            'type': 'input',
                            'class': 'form-control cls-date'
                        }
                    },
                    'resetFilter': {
                        'type': 'button',
                        'label': 'Reset Filters',
                        'symbol': 'b',
                        'attrs': {
                            'type': 'button',
                            'class': 'btn btn-sm btn-inverse v-align'
                        },
                        'initialized': function (feature) {
                            $(feature.input).click(function () {
                                $("select.ztable_length_input").val('10').change();
                                feature.ztable.reset();
                            });
                        }
                    },
                    'product': {
                        'dom': "<'form-group form-group-sm m-r-10 xs-filter'<'m-t-5'i>>",
                        'type': 'select',
                        'label': 'Product',
                        'symbol': 'p',
                        'class': 'selectpicker',
                        'attrs': {
                            'data-style': 'btn-white btn-sm',
                            'multiple': 'multiple',
                            'title': 'Select Product',
                            'data-selected-text-format': 'count > 3',
                            'data-width': 'auto',
                            'data-size': 5
                        },
                        'resetValue': function (feature) {
                            $(feature.input).selectpicker('val', feature.feature.value);
                        },
                        'initialized': function (feature) {
                            feature.ztable.waitDrawTable();
                            $.ajax({
                                'url': '{{ path('product.list_search') }}',
                                'success': function (data) {
                                    var options = {};
                                    for (var i in data) {
                                        $(feature.input).append("<option value='" + data[i].id + "'>" + data[i].name + "</option>");
                                    }
                                    $(feature.input).selectpicker('refresh');
                                    feature.ztable.reloadTable();
                                }
                            });
                            $(feature.input).change(function () {
                                feature.ztable.waitDrawTable();
                                feature.ztable.reloadTable();
                            });
                        }
                    },
                    'paymentOption': {
                        'dom': "<'form-group form-group-sm m-r-10 xs-filter'<'m-t-5'i>>",
                        'type': 'select',
                        'label': 'P.O',
                        'symbol': 'o',
                        'class': 'selectpicker',
                        'attrs': {
                            'data-style': 'btn-white btn-sm',
                            'multiple': 'multiple',
                            'title': 'Select Payment Options',
                            'data-selected-text-format': 'count > 3',
                            'data-width': 'auto',
                            'data-size': 5
                        },
                        'resetValue': function (feature) {
                            $(feature.input).selectpicker('val', feature.feature.value);
                        },
                        'initialized': function (feature) {
                            feature.ztable.waitDrawTable();
                            $.ajax({
                                'url': '{{ path('paymentoption.search') }}',
                                'success': function (data) {
                                    var options = {};
                                    for (var i in data.data) {
                                        $(feature.input).append("<option value='" + data.data[i].code + "'>" + data.data[i].name + "</option>");
                                    }
                                    $(feature.input).selectpicker('refresh');
                                    feature.ztable.reloadTable();
                                }
                            });
                            $(feature.input).change(function () {
                                feature.ztable.waitDrawTable();
                                feature.ztable.reloadTable();
                            });
                        }
                    },
                    'types': {
                        'dom': "<'form-group form-group-sm m-r-10 xs-filter'<'m-t-5'i>>",
                        'type': 'select',
                        'label': 'Type',
                        'symbol': 'y',
                        'class': 'selectpicker',
                        'attrs': {
                            'data-style': 'btn-white btn-sm',
                            'multiple': 'multiple',
                            'title': 'Select Type',
                            'data-selected-text-format': 'count > 3',
                            'data-width': 'auto',
                            'data-size': 5
                        },
                        'resetValue': function (feature) {
                            $(feature.input).selectpicker('val', feature.feature.value);
                        },
                        'rendered': function (feature) {
                             $(feature.input).selectpicker('val', feature.feature.value);
                        },
                        'initialized': function (feature) {
                            $(feature.input).change(function () {
                                feature.ztable.waitDrawTable();
                                feature.ztable.reloadTable();
                            });
                        },
                        'choices': {
                            'deposit': "Deposit",
                            'withdraw': "Withdraw",
                            'transfer': "Transfer",
                            'p2ptransfer': "P2P Transfer",
                            'dwl': "Win/Loss"
                        },
                        'value': ''
                    }
                },
                'columns': [
                    {
                        'data': 'number',
                        'defaultContent': '',
                        'name': 'number',
                        'render': function (data, type, full) {
                            return "<a href='"+full._link.page+"' target='_blank'>"+data+"</a>";
                        }
                    },
                    {
                        'name': 'date',
                        'data': 'date',
                        'defaultContent': '',
                        'render': function (data, type, full) {
                            return moment(data).format('MMM D, YYYY h:mm A');
                        }
                    },
                    {
                        'name': 'customer.full_name',
                        'data': 'customer.full_name',
                        'defaultContent': ''                        
                    },
                    {
                        'data': 'sub_transactions',
                        'defaultContent': '',
                        'name': 'sub_transactions',
                        'render': function (data, type, full) {

                            if (data === null) {
                                return '';
                            }

                            var productUsername = '';
                            $.each(data , function(key,val) {
                                productUsername  += '&nbsp;' + val.customer_product.product.name + '(' + val.customer_product.username + '),';
                            });
                            productUsername = productUsername.replace(/,*$/, "");
                            productUsername = productUsername.split(",");
                            var moreThan = '';
                            $i = 1;
                            if (productUsername.length > 2) {

                                $.each(productUsername , function(key,val) {
                                    moreThan  += val + ',';
                                    if ($i == 2) {
                                        productUsername = moreThan;
                                    }
                                    $i++;
                                });
                                productUsername = productUsername.replace(/,*$/, "...");
                            }

                            return productUsername;
                        }
                    },
                    {
                        'data': 'payment_option',
                        'defaultContent': '',
                        'name': 'payment_option',
                        'render': function (data, type, full) {
                            var paymentOption = '';
                            if (data != null) {
                                paymentOption = data.type + '(' + data.fields.email + ')';
                            }

                            return paymentOption;
                        }
                    },
                    { 'data': 'currency.code', 'defaultContent': '' },
                    {
                        'name': 'amount',
                        'data': 'customer_amount',
                        'defaultContent': '',
                        'render': function (data, type, full) {
                            if (full.type_text === Global.transaction.reversed.withdraw) {
                                var amount = new Number(data);
                                var fee = new Number(full.customer_fee);
                                amount += fee;
                                
                                return amount.toFixed(2);
                            } else if (full.type_text === 'bet') {
                                var betAmount = new Number(full.amount);

                                return betAmount.toFixed(2);
                            }

                            return (new Decimal(data)).toFixed(2);
                        }
                    },
                    {
                        'data': 'status',
                        'defaultContent': '',
                        'name': 'status',
                        'render': function(data, type, full) {
                            if (full.isVoided) {
                                return "{{ "voided"|trans({}, "TransactionBundle") }}";
                            }

                            return data.label;
                        }
                    },
                    {
                        'data': 'type_text',
                        'name': 'type',
                        'defaultContent': '',
                        'render': function(data, text, full) {
                            var typeText = {
                                'deposit': "{{ "types.deposit"|trans({}, "TransactionBundle") }}",
                                'withdraw': "{{ "types.withdraw"|trans({}, "TransactionBundle") }}",
                                'transfer': "{{ "types.transfer"|trans({}, "TransactionBundle") }}",
                                'bonus': "{{ "types.bonus"|trans({}, "TransactionBundle") }}",
                                'p2p_transfer': "{{ "types.p2p_transfer"|trans({}, "TransactionBundle") }}",
                                'dwl': "{{ "types.dwl"|trans({}, "TransactionBundle") }}",
                                'bet': "{{ "types.bet"|trans({}, "TransactionBundle") }}"
                            };

                            if (data === 'dwl') {
                                if (typeof full.dwl != 'undefined') {
                                    return typeText[data] + ' - ' + moment(full.dwl.date).format('MMM D, YYYY');
                                }
                            }

                            return typeText[data];
                        }
                    }
                ]
            });

            $('#customerTransactionList').on('ztable.change.column.visible', function (e, colvis, ztable) {
                saveUserPreferences({'ui.customertransaction.list.column.visibility': ztable.getColumnVisibility()});
            });

            $('#{{ form.btnGroup.cancelAffiliate.vars.id }}').click(function() {
                window.location = "{{ path('affiliate.list_page') }}";
            });
        });
    </script>
{% endblock %}

{% block paymentOptionTemplates %}
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
    <xsl:output method="xml"/>
    <xsl:template match="items">
        <div class="payment-list row">
        </div>
    </xsl:template>
    <xsl:template match="item">
        {% for paymentOption in paymentOptions %}
            <xsl:if test="type = '{{ paymentOption.code }}'">
            <div class="card-box p-5 payment-item" id="paymentOption_{{ paymentOption.code }}">
                <div class="row">
                    <div class="col-md-3 payment-img-col">
                        <div class='payment-img'>
                            {% if paymentOption.image == '' %}
                                <i class='fa fa-credit-card-alt fa-5x'></i>
                            {% else %}
                            <img src="{{ path('app.render_file', {'fileName': paymentOption.image})|raw }}" class='paymentOptionImage'/>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-9 payment-info">
                        <div class="text-muted m-b-5 text-center"><b>{{ paymentOption.name }}</b></div>
                        {% set i = 0 %}
                        {% for field in paymentOption.fields %}
                            {% if i < 3 %}
                            <div class="row">
                                <div class="col-md-4 text-right"><b class="text-muted">{{ field.label }}:</b></div>
                                <div class='col-md-8'><xsl:value-of select="fields/{{ field.code }}"/></div>
                            </div>
                            {% endif %}
                            {% set i = i+1 %}
                        {% endfor %}
                        <div class='row'>
                            <div class="col-md-4 text-right"><b class="text-muted">Active:</b></div>
                            <div class='col-md-8'>
                                <xsl:choose>
                                    <xsl:when test="is_active = 'true'">
                                        <i class='fa fa-check text-success'></i>
                                    </xsl:when>
                                    <xsl:otherwise>
                                        <i class='fa fa-close text-danger'></i>
                                    </xsl:otherwise>
                                </xsl:choose>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </xsl:if>
        {% endfor %}
    </xsl:template>
</xsl:stylesheet>
{% endblock paymentOptionTemplates %}
