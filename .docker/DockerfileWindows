ARG BASE_IMAGE
ARG BASE_IMAGE_TAG

FROM $BASE_IMAGE:$BASE_IMAGE_TAG

COPY .docker/manifest/ /
COPY ./ /backoffice/

RUN mkdir /backoffice/vendor \
    && chown -R www /home/www/.composer /backoffice/var /backoffice/web /backoffice/vendor /backoffice/app/config /uploads

RUN su www -c 'cd /backoffice && composer install --no-scripts'

RUN chmod 755 /entrypoint-windows.sh && chmod 755 /opt/setupbo.sh

RUN sed -i 's/\r$//' /entrypoint-windows.sh && sed -i 's/\r$//' /www-cmd.sh && sed -i 's/\r$//' /opt/setupbo.sh

EXPOSE 80 443 22 8080

CMD ["/bin/sh", "/entrypoint-windows.sh"]